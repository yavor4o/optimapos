{% extends "admin/base_site.html" %}
{% load i18n admin_urls static %}

{% block title %}Approval Rules Testing - {{ document.document_number }}{% endblock %}

{% block extrahead %}
{{ block.super }}
<style>
.test-panel {
    background: #f8f9fa;
    border: 1px solid #dee2e6;
    border-radius: 4px;
    padding: 15px;
    margin: 10px 0;
}

.rule-card {
    border: 1px solid #ddd;
    border-radius: 4px;
    padding: 12px;
    margin: 8px 0;
    background: white;
}

.rule-pass {
    border-left: 4px solid #28a745;
    background: #f8fff9;
}

.rule-fail {
    border-left: 4px solid #dc3545;
    background: #fff8f8;
}

.rule-neutral {
    border-left: 4px solid #6c757d;
    background: #f8f9fa;
}

.badge {
    padding: 2px 6px;
    border-radius: 3px;
    font-size: 11px;
    font-weight: bold;
}

.badge-success { background: #28a745; color: white; }
.badge-danger { background: #dc3545; color: white; }
.badge-warning { background: #ffc107; color: black; }
.badge-info { background: #17a2b8; color: white; }
.badge-secondary { background: #6c757d; color: white; }

.test-result {
    margin: 10px 0;
    padding: 8px;
    border-radius: 4px;
}

.test-pass { background: #d4edda; color: #155724; }
.test-fail { background: #f8d7da; color: #721c24; }
.test-info { background: #d1ecf1; color: #0c5460; }
</style>
{% endblock %}

{% block content %}
<div class="module">
    <h1>üîê Approval Rules Testing Interface</h1>
    <h2>Document: {{ document.document_number }} ({{ document.supplier.name }})</h2>
    
    <!-- Current User Info -->
    <div class="test-panel">
        <h3>üë§ Current User Information</h3>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
            <div>
                <p><strong>Username:</strong> {{ current_user.username }}</p>
                <p><strong>Full Name:</strong> {{ current_user.get_full_name|default:"Not set" }}</p>
                <p><strong>Email:</strong> {{ current_user.email|default:"Not set" }}</p>
                <p><strong>Is Superuser:</strong> 
                    {% if current_user.is_superuser %}
                        <span class="badge badge-success">‚úì Yes</span>
                    {% else %}
                        <span class="badge badge-secondary">‚úó No</span>
                    {% endif %}
                </p>
                <p><strong>Is Staff:</strong> 
                    {% if current_user.is_staff %}
                        <span class="badge badge-success">‚úì Yes</span>
                    {% else %}
                        <span class="badge badge-secondary">‚úó No</span>
                    {% endif %}
                </p>
            </div>
            <div>
                <p><strong>Groups:</strong></p>
                {% if current_user.groups.all %}
                    <ul>
                        {% for group in current_user.groups.all %}
                            <li><span class="badge badge-info">{{ group.name }}</span></li>
                        {% endfor %}
                    </ul>
                {% else %}
                    <p style="color: #6c757d; font-style: italic;">No groups assigned</p>
                {% endif %}
                
                <p><strong>Key Permissions:</strong></p>
                <div style="font-size: 11px; max-height: 100px; overflow-y: auto;">
                    {% for perm in current_user.user_permissions.all %}
                        <div>{{ perm.content_type.app_label }}.{{ perm.codename }}</div>
                    {% empty %}
                        <em style="color: #6c757d;">No specific permissions</em>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>

    <!-- Document Context -->
    <div class="test-panel">
        <h3>üìã Document Context</h3>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
            <div>
                <p><strong>Document Type:</strong> {{ document.document_type.name|default:"Not set" }}</p>
                <p><strong>Current Status:</strong> <span class="badge badge-info">{{ document.status }}</span></p>
                <p><strong>Requires Approval:</strong> 
                    {% if document.document_type.requires_approval %}
                        <span class="badge badge-warning">‚úì Yes</span>
                    {% else %}
                        <span class="badge badge-success">‚úó No</span>
                    {% endif %}
                </p>
                <p><strong>Estimated Total:</strong> {{ document.get_total_estimated_cost|floatformat:2 }} –ª–≤</p>
            </div>
            <div>
                <p><strong>Requested By:</strong> {{ document.requested_by.get_full_name|default:document.requested_by.username }}</p>
                <p><strong>Urgency:</strong> <span class="badge badge-secondary">{{ document.get_urgency_level_display }}</span></p>
                <p><strong>Request Type:</strong> {{ document.get_request_type_display }}</p>
                <p><strong>Created:</strong> {{ document.created_at|date:"Y-m-d H:i" }}</p>
            </div>
        </div>
    </div>

    <!-- Approval Rules Testing -->
    <div class="test-panel">
        <h3>üîç Approval Rules Analysis</h3>
        
        {% if rules %}
            <p>Found <strong>{{ rules|length }}</strong> approval rule(s) for this document type:</p>
            
            {% for rule_test in rules %}
                <div class="rule-card {% if rule_test.can_approve %}rule-pass{% else %}rule-fail{% endif %}">
                    <div style="display: flex; justify-content: between; align-items: start;">
                        <div style="flex: 1;">
                            <h4 style="margin: 0 0 8px 0;">
                                {{ rule_test.rule.name }}
                                {% if rule_test.can_approve %}
                                    <span class="badge badge-success">‚úì CAN APPROVE</span>
                                {% else %}
                                    <span class="badge badge-danger">‚úó CANNOT APPROVE</span>
                                {% endif %}
                            </h4>
                            
                            <div style="font-size: 12px; color: #666; margin: 5px 0;">
                                <strong>Rule Details:</strong><br>
                                Level: {{ rule_test.rule.approval_level }} | 
                                Type: {{ rule_test.rule.get_approver_type_display }} |
                                Active: {% if rule_test.rule.is_active %}‚úì{% else %}‚úó{% endif %}
                            </div>
                            
                            {% if rule_test.rule.description %}
                                <div style="font-style: italic; color: #666; margin: 5px 0;">
                                    {{ rule_test.rule.description }}
                                </div>
                            {% endif %}
                            
                            <!-- Status Transition -->
                            <div style="margin: 8px 0;">
                                <strong>Transition:</strong> 
                                {% if rule_test.rule.from_status_obj %}
                                    <span class="badge badge-secondary">{{ rule_test.rule.from_status_obj.name }}</span>
                                {% else %}
                                    <span class="badge badge-secondary">Any Status</span>
                                {% endif %}
                                ‚Üí
                                {% if rule_test.rule.to_status_obj %}
                                    <span class="badge badge-info">{{ rule_test.rule.to_status_obj.name }}</span>
                                {% else %}
                                    <span class="badge badge-secondary">No Target</span>
                                {% endif %}
                            </div>
                            
                            <!-- Amount Range -->
                            {% if rule_test.rule.min_amount or rule_test.rule.max_amount %}
                                <div style="margin: 8px 0;">
                                    <strong>Amount Range:</strong>
                                    {{ rule_test.rule.min_amount|floatformat:2|default:"0" }} –ª–≤ - 
                                    {{ rule_test.rule.max_amount|floatformat:2|default:"‚àû" }} –ª–≤
                                    
                                    {% with doc_amount=document.get_total_estimated_cost %}
                                        {% if doc_amount %}
                                            {% if rule_test.rule.is_amount_in_range|default:True %}
                                                <span class="badge badge-success">‚úì In Range</span>
                                            {% else %}
                                                <span class="badge badge-danger">‚úó Out of Range</span>
                                            {% endif %}
                                        {% endif %}
                                    {% endwith %}
                                </div>
                            {% endif %}
                            
                            <!-- Approver Information -->
                            <div style="margin: 8px 0;">
                                <strong>Approver:</strong> {{ rule_test.rule.get_approver_display }}
                            </div>
                            
                            <!-- Test Results -->
                            <div style="margin: 10px 0;">
                                <strong>Test Results:</strong>
                                <div class="test-result {% if rule_test.user_matches %}test-pass{% else %}test-fail{% endif %}">
                                    {% if rule_test.user_matches %}
                                        ‚úÖ Current user matches approver criteria
                                    {% else %}
                                        ‚ùå Current user does NOT match approver criteria
                                    {% endif %}
                                </div>
                                
                                <!-- Detailed Analysis -->
                                <div style="font-size: 11px; color: #666; margin-top: 5px;">
                                    {% if rule_test.rule.approver_type == 'user' %}
                                        <div>Required User: {{ rule_test.rule.approver_user.get_full_name|default:rule_test.rule.approver_user.username }}</div>
                                        <div>Current User: {{ current_user.get_full_name|default:current_user.username }}</div>
                                        <div>Match: {% if rule_test.rule.approver_user == current_user %}‚úì{% else %}‚úó{% endif %}</div>
                                    {% elif rule_test.rule.approver_type == 'role' %}
                                        <div>Required Group: {{ rule_test.rule.approver_role.name }}</div>
                                        <div>User Groups: 
                                            {% for group in current_user.groups.all %}
                                                {{ group.name }}{% if not forloop.last %}, {% endif %}
                                            {% empty %}
                                                None
                                            {% endfor %}
                                        </div>
                                        <div>Match: {% if current_user.groups.filter(id=rule_test.rule.approver_role.id).exists %}‚úì{% else %}‚úó{% endif %}</div>
                                    {% elif rule_test.rule.approver_type == 'permission' %}
                                        <div>Required Permission: {{ rule_test.rule.approver_permission.content_type.app_label }}.{{ rule_test.rule.approver_permission.codename }}</div>
                                        <div>User Has Permission: {% if current_user.has_perm %}‚úì{% else %}‚úó{% endif %}</div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        
                        <!-- Quick Test Button -->
                        <div style="margin-left: 15px;">
                            <button onclick="testRule({{ rule_test.rule.id }}, '{{ rule_test.rule.name|escapejs }}')" 
                                    style="background: #007bff; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer;">
                                üß™ Test Rule
                            </button>
                        </div>
                    </div>
                </div>
            {% endfor %}
            
        {% else %}
            <div class="test-result test-info">
                ‚ÑπÔ∏è No approval rules found for document type: {{ document.document_type.name|default:"Unknown" }}
            </div>
            
            {% if not document.document_type %}
                <div class="test-result test-fail">
                    ‚ùå Document has no document type assigned! Please assign a document type first.
                </div>
            {% elif not document.document_type.requires_approval %}
                <div class="test-result test-info">
                    ‚ÑπÔ∏è Document type does not require approval (requires_approval = False)
                </div>
            {% endif %}
        {% endif %}
    </div>

    <!-- Workflow Permissions Testing -->
    <div class="test-panel">
        <h3>üéØ Workflow Permissions Testing</h3>
        
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
            <div>
                <h4>Document Permissions</h4>
                <div class="test-result test-info">
                    <div><strong>Can Edit Document:</strong> 
                        {% if document.can_edit %}
                            <span class="badge badge-success">‚úì Yes</span>
                        {% else %}
                            <span class="badge badge-danger">‚úó No</span>
                        {% endif %}
                    </div>
                </div>
                
                <h4>Available Actions</h4>
                {% with actions=document.get_available_actions %}
                    {% if actions %}
                        {% for action in actions %}
                            <div style="margin: 5px 0; padding: 5px; border: 1px solid #ddd; border-radius: 3px;">
                                <strong>{{ action.label }}</strong><br>
                                <small>{{ action.action }} ‚Üí {{ action.status|default:"N/A" }}</small>
                            </div>
                        {% endfor %}
                    {% else %}
                        <div class="test-result test-fail">
                            ‚ùå No actions available for current user
                        </div>
                    {% endif %}
                {% endwith %}
            </div>
            
            <div>
                <h4>System Permissions</h4>
                <div style="font-size: 12px;">
                    <div><strong>Add Purchase Request:</strong> 
                        {% if perms.purchases.add_purchaserequest %}‚úì{% else %}‚úó{% endif %}
                    </div>
                    <div><strong>Change Purchase Request:</strong> 
                        {% if perms.purchases.change_purchaserequest %}‚úì{% else %}‚úó{% endif %}
                    </div>
                    <div><strong>Delete Purchase Request:</strong> 
                        {% if perms.purchases.delete_purchaserequest %}‚úì{% else %}‚úó{% endif %}
                    </div>
                    <div><strong>View Purchase Request:</strong> 
                        {% if perms.purchases.view_purchaserequest %}‚úì{% else %}‚úó{% endif %}
                    </div>
                </div>
                
                <h4 style="margin-top: 15px;">Custom Permissions</h4>
                <div style="font-size: 12px;">
                    <div><strong>Approve Purchase Requests:</strong> 
                        {% if perms.purchases.approve_purchaserequest %}‚úì{% else %}‚úó{% endif %}
                    </div>
                    <div><strong>Convert to Orders:</strong> 
                        {% if perms.purchases.convert_purchaserequest %}‚úì{% else %}‚úó{% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Approval Simulation -->
    <div class="test-panel">
        <h3>üé¨ Approval Flow Simulation</h3>
        
        <div id="simulation-results">
            <p>Test what happens when different users try to approve this document:</p>
            
            <div style="margin: 10px 0;">
                <button onclick="simulateCurrentUserApproval()" 
                        style="background: #28a745; color: white; border: none; padding: 8px 16px; border-radius: 4px; margin-right: 10px;">
                    üéØ Simulate Current User Approval
                </button>
                
                <button onclick="simulateSuperuserApproval()" 
                        style="background: #dc3545; color: white; border: none; padding: 8px 16px; border-radius: 4px; margin-right: 10px;">
                    üëë Simulate Superuser Approval
                </button>
                
                <button onclick="showApprovalMatrix()" 
                        style="background: #6c757d; color: white; border: none; padding: 8px 16px; border-radius: 4px;">
                    üìä Show Approval Matrix
                </button>
            </div>
            
            <div id="simulation-output" style="margin-top: 15px; padding: 10px; background: #f8f9fa; border-radius: 4px; min-height: 50px;">
                <em>Click a simulation button to see results...</em>
            </div>
        </div>
    </div>

    <!-- Test Log -->
    <div class="test-panel">
        <h3>üìä Test Log</h3>
        <div id="test-log" style="max-height: 300px; overflow-y: auto; background: white; padding: 10px; border: 1px solid #ddd; border-radius: 4px;">
            <div style="color: #6c757d; font-style: italic;">
                Test log initialized - {{ current_user.username }} - {% now "Y-m-d H:i:s" %}
            </div>
        </div>
        
        <button onclick="clearTestLog()" style="background: #6c757d; color: white; border: none; padding: 4px 8px; border-radius: 4px; font-size: 11px; margin-top: 5px;">
            üóëÔ∏è Clear Log
        </button>
    </div>

    <!-- Back Button -->
    <div style="margin: 20px 0;">
        <a href="{% url 'admin:purchases_purchaserequest_change' document.pk %}" 
           style="background: #6c757d; color: white; padding: 8px 16px; border-radius: 4px; text-decoration: none;">
            ‚Üê Back to Document
        </a>
        
        <a href="{% url 'admin:purchases_purchaserequest_test_workflow' document.pk %}" 
           style="background: #007bff; color: white; padding: 8px 16px; border-radius: 4px; text-decoration: none; margin-left: 10px;">
            üîÑ Workflow Testing
        </a>
    </div>
</div>

<script>
// Global variables
let documentId = {{ document.pk }};
let testCounter = 0;

// Test specific rule
function testRule(ruleId, ruleName) {
    logTest(`üß™ Testing rule: ${ruleName} (ID: ${ruleId})`);
    
    // Simulate rule testing logic
    fetch('/admin/test-rule-ajax/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify({
            'rule_id': ruleId,
            'document_id': documentId,
            'user_id': {{ current_user.id }}
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            logTest(`‚úÖ Rule test passed: ${data.message}`);
        } else {
            logTest(`‚ùå Rule test failed: ${data.message}`);
        }
    })
    .catch(error => {
        logTest(`üí• Rule test error: ${error}`);
    });
}

// Simulate current user approval
function simulateCurrentUserApproval() {
    logTest('üéØ Simulating current user approval...');
    
    const output = document.getElementById('simulation-output');
    
    let html = '<h4>Current User Approval Simulation</h4>';
    html += '<div><strong>User:</strong> {{ current_user.get_full_name|default:current_user.username }}</div>';
    html += '<div><strong>Status:</strong> {{ document.status }}</div>';
    
    // Check rules
    let canApprove = false;
    let applicableRules = [];
    
    {% for rule_test in rules %}
        {% if rule_test.can_approve %}
            canApprove = true;
            applicableRules.push('{{ rule_test.rule.name|escapejs }}');
        {% endif %}
    {% endfor %}
    
    if (canApprove) {
        html += '<div class="test-result test-pass">';
        html += '‚úÖ <strong>CAN APPROVE</strong><br>';
        html += 'Applicable rules: ' + applicableRules.join(', ');
        html += '</div>';
    } else {
        html += '<div class="test-result test-fail">';
        html += '‚ùå <strong>CANNOT APPROVE</strong><br>';
        html += 'No matching approval rules for current user';
        html += '</div>';
    }
    
    output.innerHTML = html;
    logTest(`Simulation result: ${canApprove ? 'CAN APPROVE' : 'CANNOT APPROVE'}`);
}

// Simulate superuser approval
function simulateSuperuserApproval() {
    logTest('üëë Simulating superuser approval...');
    
    const output = document.getElementById('simulation-output');
    
    let html = '<h4>Superuser Approval Simulation</h4>';
    html += '<div><strong>Superuser Override:</strong> {{ current_user.is_superuser|yesno:"Enabled,Disabled" }}</div>';
    
    {% if current_user.is_superuser %}
        html += '<div class="test-result test-pass">';
        html += '‚úÖ <strong>SUPERUSER CAN APPROVE</strong><br>';
        html += 'Superusers can bypass all approval rules';
        html += '</div>';
    {% else %}
        html += '<div class="test-result test-info">';
        html += '‚ÑπÔ∏è <strong>NOT A SUPERUSER</strong><br>';
        html += 'Current user does not have superuser privileges';
        html += '</div>';
    {% endif %}
    
    output.innerHTML = html;
    logTest('Superuser simulation completed');
}

// Show approval matrix
function showApprovalMatrix() {
    logTest('üìä Generating approval matrix...');
    
    const output = document.getElementById('simulation-output');
    
    let html = '<h4>Approval Matrix</h4>';
    html += '<table style="width: 100%; border-collapse: collapse; font-size: 12px;">';
    html += '<thead><tr style="background: #f8f9fa;">';
    html += '<th style="border: 1px solid #ddd; padding: 8px;">Rule</th>';
    html += '<th style="border: 1px solid #ddd; padding: 8px;">Level</th>';
    html += '<th style="border: 1px solid #ddd; padding: 8px;">Approver Type</th>';
    html += '<th style="border: 1px solid #ddd; padding: 8px;">Current User</th>';
    html += '<th style="border: 1px solid #ddd; padding: 8px;">Status</th>';
    html += '</tr></thead><tbody>';
    
    {% for rule_test in rules %}
        html += '<tr>';
        html += '<td style="border: 1px solid #ddd; padding: 8px;">{{ rule_test.rule.name|escapejs }}</td>';
        html += '<td style="border: 1px solid #ddd; padding: 8px;">{{ rule_test.rule.approval_level }}</td>';
        html += '<td style="border: 1px solid #ddd; padding: 8px;">{{ rule_test.rule.get_approver_type_display|escapejs }}</td>';
        html += '<td style="border: 1px solid #ddd; padding: 8px;">{{ current_user.username|escapejs }}</td>';
        html += '<td style="border: 1px solid #ddd; padding: 8px;">';
        {% if rule_test.can_approve %}
            html += '<span class="badge badge-success">‚úì Can Approve</span>';
        {% else %}
            html += '<span class="badge badge-danger">‚úó Cannot Approve</span>';
        {% endif %}
        html += '</td></tr>';
    {% endfor %}
    
    html += '</tbody></table>';
    
    output.innerHTML = html;
    logTest('Approval matrix generated');
}

// Log test activity
function logTest(message) {
    const log = document.getElementById('test-log');
    const timestamp = new Date().toLocaleString();
    testCounter++;
    
    const entry = document.createElement('div');
    entry.style.cssText = 'padding: 5px; border-bottom: 1px solid #eee; margin: 2px 0;';
    entry.innerHTML = `<strong>[${testCounter}]</strong> ${message} - <small>${timestamp}</small>`;
    
    log.insertBefore(entry, log.firstChild);
    
    // Keep only last 50 entries
    while (log.children.length > 51) {
        log.removeChild(log.lastChild);
    }
}

// Clear test log
function clearTestLog() {
    const log = document.getElementById('test-log');
    log.innerHTML = '<div style="color: #6c757d; font-style: italic;">Log cleared - {{ current_user.username }} - ' + new Date().toLocaleString() + '</div>';
    testCounter = 0;
    logTest('Test log initialized');
}

// Get CSRF cookie
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// Initialize page
document.addEventListener('DOMContentLoaded', function() {
    logTest('Approval rules testing interface loaded');
    logTest(`Found {{ rules|length }} approval rule(s) for testing`);
    
    {% if current_user.is_superuser %}
        logTest('üëë Current user is superuser - can bypass approval rules');
    {% endif %}
});
</script>
{% endblock %}