{% extends 'frontend/base.html' %}
{% load i18n %}
{% load static %}
{% load mptt_tags %}

{% block title %}{{ page_title }} - {{ block.super }}{% endblock %}

{% block content %}
<div class="kt-container-fixed">

    <!-- Page Header -->
    <div class="flex flex-wrap items-center lg:items-end justify-between gap-5 pb-7.5">
        <div class="flex flex-col justify-center gap-2">
            <h1 class="text-xl font-medium leading-none text-mono">
                {% trans "Product Groups" %}
            </h1>
            <div class="flex items-center gap-2 text-sm font-normal text-secondary-foreground">
                {% trans "Hierarchical product group management" %}
            </div>
        </div>

        <!-- Action Buttons -->
        <div class="flex items-center gap-2.5">
            <a class="kt-btn kt-btn-primary" href="{% url 'nomenclatures:product_groups_create' %}">
                <i class="ki-filled ki-plus"></i>
                {% trans "Add Product Group" %}
            </a>

            <!-- View Mode Toggle -->
            <div class="kt-btn-group" data-kt-buttons="true">
                <a href="?view=flat" class="kt-btn kt-btn-sm kt-btn-outline {% if view_mode == 'flat' %}active{% endif %}">
                    <i class="ki-filled ki-row-horizontal"></i>
                    {% trans "List" %}
                </a>
                <a href="?view=tree" class="kt-btn kt-btn-sm kt-btn-outline {% if view_mode == 'tree' %}active{% endif %}">
                    <i class="ki-filled ki-abstract-14"></i>
                    {% trans "Tree" %}
                </a>
            </div>
        </div>
    </div>

    <!-- Main Content Card -->
    <div class="kt-card">
        <div class="kt-card-header">
            <h3 class="kt-card-title">
                {% trans "Product Groups" %} ({{ total_count }})
            </h3>
        </div>

        <div class="kt-card-body">
            {% if view_mode == 'tree' %}
                <!-- Tree View -->
                <div class="space-y-2">
                    {% recursetree object_list %}
                        <div class="tree-node level-{{ node.level }}">
                            <div class="flex items-center gap-3 p-3 hover:bg-accent/50 rounded-lg">
                                <div class="flex items-center gap-2">
                                    <i class="ki-filled ki-abstract-14 text-muted-foreground"></i>
                                    <span class="font-bold text-primary">{{ node.code }}</span>
                                    <span class="text-muted-foreground">-</span>
                                    <span>{{ node.name }}</span>
                                    <span class="text-xs text-muted-foreground">(Level {{ node.level }})</span>
                                </div>

                                <div class="ms-auto flex items-center gap-2">
                                    {% if node.is_active %}
                                    <span class="kt-badge kt-badge-success kt-badge-sm">{% trans "Active" %}</span>
                                    {% else %}
                                    <span class="kt-badge kt-badge-warning kt-badge-sm">{% trans "Inactive" %}</span>
                                    {% endif %}

                                    <div class="kt-btn-group">
                                        <button type="button"
                                                class="kt-btn kt-btn-sm kt-btn-icon kt-btn-ghost"
                                                onclick="showGroupDetailModal({{ node.pk }})"
                                                title="{% trans 'View Details' %}">
                                            <i class="ki-filled ki-eye"></i>
                                        </button>
                                        <a href="{% url 'nomenclatures:product_groups_edit' node.pk %}" class="kt-btn kt-btn-sm kt-btn-icon kt-btn-ghost">
                                            <i class="ki-filled ki-notepad-edit"></i>
                                        </a>
                                    </div>
                                </div>
                            </div>

                            {% if not node.is_leaf_node %}
                            <div class="ms-6">
                                {{ children }}
                            </div>
                            {% endif %}
                        </div>
                    {% endrecursetree %}
                </div>
            {% else %}
                <!-- Table View -->
                <div class="table-responsive">
                    <table class="kt-table kt-table-border kt-table-rounded">
                        <thead>
                            <tr>
                                <th>{% trans "Code" %}</th>
                                <th>{% trans "Name" %}</th>
                                <th>{% trans "Parent Group" %}</th>
                                <th>{% trans "Level" %}</th>
                                <th>{% trans "Status" %}</th>
                                <th>{% trans "Actions" %}</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for group in object_list %}
                            <tr>
                                <td><strong>{{ group.code }}</strong></td>
                                <td>{{ group.name }}</td>
                                <td>
                                    {% if group.parent %}
                                        {{ group.parent.name }}
                                    {% else %}
                                        <span class="text-muted-foreground">{% trans "Root Group" %}</span>
                                    {% endif %}
                                </td>
                                <td>{{ group.level }}</td>
                                <td>
                                    {% if group.is_active %}
                                        <span class="kt-badge kt-badge-success kt-badge-sm">{% trans "Active" %}</span>
                                    {% else %}
                                        <span class="kt-badge kt-badge-warning kt-badge-sm">{% trans "Inactive" %}</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <div class="kt-btn-group">
                                        <button type="button"
                                                class="kt-btn kt-btn-sm kt-btn-icon kt-btn-ghost"
                                                onclick="showGroupDetailModal({{ group.pk }})"
                                                title="{% trans 'View Details' %}">
                                            <i class="ki-filled ki-eye"></i>
                                        </button>
                                        <a href="{% url 'nomenclatures:product_groups_edit' group.pk %}" class="kt-btn kt-btn-sm kt-btn-icon kt-btn-ghost">
                                            <i class="ki-filled ki-notepad-edit"></i>
                                        </a>
                                    </div>
                                </td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="6" class="text-center py-8">
                                    <div class="flex flex-col items-center">
                                        <i class="ki-filled ki-abstract-14 text-muted-foreground text-4xl mb-3"></i>
                                        <h4 class="text-muted-foreground mb-2">{% trans "No Product Groups Found" %}</h4>
                                        <p class="text-muted-foreground">{% trans "Get started by creating your first product group." %}</p>
                                        <a href="{% url 'nomenclatures:product_groups_create' %}" class="kt-btn kt-btn-primary mt-3">
                                            <i class="ki-filled ki-plus"></i>
                                            {% trans "Create First Group" %}
                                        </a>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Modal HTML - inline в същия файл -->
<div class="kt-modal" data-kt-modal="true" id="groupDetailModal">
    <div class="kt-modal-content max-w-[500px] w-full">
        <!-- Modal Header -->
        <div class="kt-modal-header">
            <h3 class="kt-modal-title" id="groupDetailModalTitle">
                {% trans "Group Details" %}
            </h3>
            <button class="btn btn-sm btn-icon btn-light" data-kt-modal-dismiss="true">
                <i class="ki-filled ki-cross"></i>
            </button>
        </div>

        <!-- Modal Body -->
        <div class="kt-modal-body" id="groupDetailModalBody">
            <!-- Loading State -->
            <div class="text-center py-8">
                <div class="spinner-border text-primary mb-3"></div>
                <div class="text-sm text-gray-600">{% trans "Loading..." %}</div>
            </div>
        </div>

        <!-- Modal Footer -->
        <div class="kt-modal-footer">
            <button type="button" class="btn btn-light" data-kt-modal-dismiss="true">
                {% trans "Close" %}
            </button>
        </div>
    </div>
</div>

<script>
// Modal JavaScript - inline в същия файл
window.showGroupDetailModal = async function(groupId) {
    const modalEl = document.getElementById('groupDetailModal');
    const modal = KTModal.getInstance(modalEl);
    const modalTitle = document.getElementById('groupDetailModalTitle');
    const modalBody = document.getElementById('groupDetailModalBody');

    // Loading state
    modalTitle.textContent = '{% trans "Loading..." %}';
    modalBody.innerHTML = `
        <div class="text-center py-8">
            <div class="spinner-border text-primary mb-3"></div>
            <div class="text-sm text-gray-600">{% trans "Loading group details..." %}</div>
        </div>
    `;

    // Show modal
    if (modal) {
        modal.show();
    }

    try {
        const response = await fetch(`{% url 'nomenclatures:product_groups_detail_modal' 0 %}`.replace('0', groupId));
        const data = await response.json();

        if (data.success) {
            modalTitle.textContent = data.title;

            // Inline modal content template
            modalBody.innerHTML = `
                <div class="space-y-4">
                    <!-- Header with basic info -->
                    <div class="flex items-center gap-3 p-4 bg-gray-50 rounded-lg">
                        <div class="w-10 h-10 bg-primary/10 rounded-lg flex items-center justify-center">
                            <i class="ki-filled ki-abstract-14 text-primary"></i>
                        </div>
                        <div class="flex-1">
                            <div class="font-semibold text-gray-900">${data.group?.name || 'N/A'}</div>
                            <div class="text-sm text-gray-600 flex items-center gap-2">
                                <span class="font-mono bg-gray-200 px-2 py-0.5 rounded text-xs">${data.group?.code || 'N/A'}</span>
                                <span>•</span>
                                <span>Level ${data.group?.level || 0}</span>
                                ${data.group?.is_active ? '<span class="text-green-600">• Active</span>' : '<span class="text-orange-600">• Inactive</span>'}
                            </div>
                        </div>
                    </div>

                    <!-- Stats row -->
                    <div class="grid grid-cols-3 gap-3">
                        <div class="text-center p-3 bg-blue-50 rounded-lg">
                            <div class="text-lg font-bold text-blue-600">${data.group?.level || 0}</div>
                            <div class="text-xs text-blue-700">Level</div>
                        </div>
                        <div class="text-center p-3 bg-green-50 rounded-lg">
                            <div class="text-lg font-bold text-green-600">${data.children_count || 0}</div>
                            <div class="text-xs text-green-700">Children</div>
                        </div>
                        <div class="text-center p-3 bg-purple-50 rounded-lg">
                            <div class="text-lg font-bold text-purple-600">${data.descendants_count || 0}</div>
                            <div class="text-xs text-purple-700">Total</div>
                        </div>
                    </div>

                    ${data.group?.parent ? `
                    <!-- Parent info -->
                    <div class="p-3 border border-gray-200 rounded-lg">
                        <div class="text-xs text-gray-500 mb-1">Parent Group</div>
                        <div class="flex items-center gap-2">
                            <i class="ki-filled ki-arrow-up text-gray-400 text-sm"></i>
                            <span class="font-medium">${data.group.parent.name}</span>
                            <span class="text-sm text-gray-500">(${data.group.parent.code})</span>
                        </div>
                    </div>
                    ` : ''}

                    ${data.group?.description ? `
                    <!-- Description -->
                    <div class="p-3 bg-gray-50 rounded-lg">
                        <div class="text-xs text-gray-500 mb-1">Description</div>
                        <div class="text-sm text-gray-700">${data.group.description}</div>
                    </div>
                    ` : ''}

                    <!-- Actions -->
                    <div class="flex gap-2 pt-2">
                        <a href="/nomenclatures/product-groups/${groupId}/edit/" class="btn btn-primary flex-1">
                            <i class="ki-filled ki-notepad-edit"></i>
                            Edit
                        </a>
                        <a href="/nomenclatures/product-groups/create/?parent=${groupId}" class="btn btn-light flex-1">
                            <i class="ki-filled ki-plus"></i>
                            Add Child
                        </a>
                    </div>
                </div>
            `;
        } else {
            throw new Error(data.error || '{% trans "Failed to load group details" %}');
        }
    } catch (error) {
        console.error('Error:', error);
        modalBody.innerHTML = `
            <div class="text-center py-8">
                <div class="text-red-500 mb-2">
                    <i class="ki-filled ki-information-5 text-2xl"></i>
                </div>
                <div class="text-sm text-gray-600">{% trans "Error loading details" %}</div>
                <button class="btn btn-primary btn-sm mt-3" onclick="showGroupDetailModal(${groupId})">
                    {% trans "Try Again" %}
                </button>
            </div>
        `;
    }
};

window.confirmDelete = function(deleteUrl) {
    if (confirm('{% trans "Delete this group?" %}')) {
        window.location.href = deleteUrl;
    }
};
</script>

{% endblock %}