# Преглед на OptimaPOS Система

## 🎯 Изпълнително резюме

**OptimaPOS** е enterprise-клас система за продажби и управление на складове, построена с Django, проектирана за сложни търговски/търговски на едро операции. Системата включва модулна архитектура със **унифицирана service facade архитектура**, софистицирани документни workflow-ове, следене на складови запаси в реално време, многостъпково ценообразуване и изчерпателно управление на партньори.

## 📋 Съдържание

1. [Системна архитектура](#системна-архитектура)
2. [Основна философия](#основна-философия)
3. [Преглед на приложенията](#преглед-на-приложенията)
4. [Ключови функционалности](#ключови-функционалности)
5. [Интеграционна архитектура](#интеграционна-архитектура)
6. [Поток от данни](#поток-от-данни)
7. [Технологичен стек](#технологичен-стек)
8. [Архитектура за внедряване](#архитектура-за-внедряване)
9. [Сигурност и производителност](#сигурност-и-производителност)
10. [Насоки за разработка](#насоки-за-разработка)

---

## Системна архитектура

```
OptimaPOS Системна архитектура:

┌─────────────────────────────────────────────────────────────────┐
│                    FRONTEND СЛОЙ                               │
│  Web интерфейс • POS терминал • Мобилно приложение • Admin     │
└─────────────────────────┬───────────────────────────────────────┘
                         │
┌─────────────────────────┴───────────────────────────────────────┐
│                    БИЗНЕС ЛОГИКА СЛОЙ                         │
│                                                                 │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐             │
│  │ PURCHASES   │  │   ПРОДАЖБИ  │  │   ОТЧЕТИ    │             │
│  │ Документен  │  │ Управление  │  │ Анализи     │             │
│  │ Workflow    │  │ и POS       │  │ и BI        │             │
│  └─────────────┘  └─────────────┘  └─────────────┘             │
│                          │                                      │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐             │
│  │NOMENCLATURES│  │  INVENTORY  │  │   PRICING   │             │
│  │ Централен   │  │ Склад в     │  │ Многостъпк. │             │
│  │ Хъб Услуги  │  │ реал. време │  │ Ценообр.    │             │
│  └─────────────┘  └─────────────┘  └─────────────┘             │
│                          │                                      │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐             │
│  │  PRODUCTS   │  │  PARTNERS   │  │    CORE     │             │
│  │ Каталог и   │  │ Клиенти и   │  │ Основни     │             │
│  │ Жизн. цикъл │  │ Доставчици │  │ Услуги      │             │
│  └─────────────┘  └─────────────┘  └─────────────┘             │
└─────────────────────────┬───────────────────────────────────────┘
                         │
┌─────────────────────────┴───────────────────────────────────────┐
│                  СЛОЙ ЗА ДОСТЪП ДО ДАННИ                      │
│  Django ORM • Database Migrations • Query Optimization         │
└─────────────────────────┬───────────────────────────────────────┘
                         │
┌─────────────────────────┴───────────────────────────────────────┐
│                   ИНФРАСТРУКТУРЕН СЛОЙ                        │
│  PostgreSQL Database • Redis Cache • File Storage • Logging    │
└─────────────────────────────────────────────────────────────────┘
```

### Принципи на модулния дизайн

- **🏗️ Слоеста архитектура** - Ясно разделение на задълженията
- **🔄 Service Facade Pattern** - Централизирани услуги в nomenclatures/
- **📊 Конфигурационно-базирана** - Бизнес правила дефинирани чрез конфигурация
- **⚡ Service Registry Pattern** - Централизирано управление на service dependencies
- **🔒 Result Pattern** - Всички service методи връщат Result обекти

---

## Основна философия

### 1. **Service Facade Pattern** - Унифицирана архитектура

Всички операции преминават през централизирани услуги в `nomenclatures/services/`:

```python
# Nomenclatures - Централен хъб с цялата бизнес логика
from nomenclatures.services import DocumentService

# App модули - Тънки обвивки които делегират
class PurchaseDocumentService:
    def __init__(self, user):
        self.facade = DocumentService(document, user)  # Делегира всичко
```

### 2. **Result Pattern** - Консистентно обработване на грешки

Всички бизнес операции връщат `Result` обекти вместо да хвърлят изключения:

```python
from core.utils.result import Result

result = DocumentService.create_document(data)
if result.ok:
    document = result.data
else:
    error_message = result.msg
```

### 3. **Service Registry Pattern** - Интерфейс-базирано управление

Централизирано управление на service dependencies чрез интерфейси:

```python
from core.interfaces.service_registry import ServiceRegistry

# Resolve services по интерфейс име
pricing_service = ServiceRegistry.resolve('IPricingService')
product_service = ServiceRegistry.resolve('IProductService')
```

### 4. **StatusResolver - Динамична конфигурация**

Системата избягва hardcoded стойности чрез configuration-driven подход:

```python
from nomenclatures.services._status_resolver import StatusResolver

# Никога не използвай hardcoded имена на статуси
editable_statuses = StatusResolver.get_editable_statuses(document_type)
can_edit = document.status in editable_statuses

# Semantic status resolution (работи на всички езици)
approval_statuses = StatusResolver.get_statuses_by_semantic_type(
    document_type, 'approval'
)
```

---

## Преглед на приложенията

### **CORE** - Основна инфраструктура
- **Цел**: База модели, утилити, интерфейси, Result pattern
- **Ключови компоненти**: Result клас, service registry, base модели
- **Зависимости**: Няма (основен слой)

### **NOMENCLATURES** - Централен хъб за документи
- **Цел**: Система за класификация и документен workflow engine
- **Ключови компоненти**: DocumentService facade, StatusResolver, ApprovalService
- **Ключови функции**: Status-driven workflows, интегрирана валидация, движения

### **PRODUCTS** - Продуктов каталог
- **Цел**: Продуктови дефиниции с lifecycle управление
- **Ключови компоненти**: Product модел, packaging система, баркод/PLU поддръжка
- **Ключови функции**: Lifecycle states, unit conversions, enterprise създаване

### **INVENTORY** - Управление на склада
- **Цел**: Следене на складови запаси в реално време с FIFO и batch поддръжка
- **Ключови компоненти**: MovementService, InventoryItem (кеш)
- **Ключови функции**: Документно-базирани движения, FIFO/batch следене

### **PRICING** - Многостъпково ценообразуване
- **Цел**: Софистицирано ценообразуване с клиентски групи и промоции
- **Ключови компоненти**: ProductPrice, групово ценообразуване, VATCalculationService
- **Ключови функции**: Ценообразуване на база себестойност, специфично за локация

### **PARTNERS** - Бизнес отношения
- **Цел**: Управление на клиенти и доставчици с графици и кредит
- **Ключови компоненти**: Customer/Supplier модели, сайтове, графици
- **Ключови функции**: Кредитно управление, графици за доставка, multi-site поддръжка

### **PURCHASES** - Workflow за доставки
- **Цел**: Жизнен цикъл на покупки (Request → Order → Delivery)
- **Ключови компоненти**: Тънки обвивки които делегират към nomenclatures
- **Ключови функции**: Документни конвертации, интегрирана валидация

---

## Ключови функционалности

### 🏢 **Enterprise документен workflow**
```
Заявка за покупка → Поръчка за покупка → Получена доставка
       ↓                    ↓                  ↓
   Планиране          Ангажимент        Складова актуализация

Преходите на статусите автоматично:
• Създават складови движения
• Актуализират себестойности и ценообразуване
• Задействат бизнес правила
• Валидират ограничения
```

### 📊 **Управление на склада в реално време**
- **Movement-Centric**: Всички промени се следят като движения
- **FIFO/Batch поддръжка**: Автоматично следене на партиди с дати на изтичане
- **Много локации**: Продукти се следят в склади/магазини
- **Десетична точност**: 4dp за себестойности, 2dp за дисплей цени

### 💰 **Многостъпкова система за ценообразуване**
```
Приоритет на цените: Промоция → Клиентска група → Стъпкова цена → Базова цена

• Специфично за локация ценообразуване
• Отстъпки на клиентски групи
• Количествено-базирано стъпково ценообразуване
• Ограничени по време промоции
• Калкулации на markup базирани на себестойност
```

### 🏷️ **Усъвършенствано управление на продукти**
- **Lifecycle управление**: NEW → ACTIVE → PHASE_OUT → DISCONTINUED → ARCHIVED
- **Многоединична поддръжка**: Базови единици + packaging конфигурации
- **Баркод/PLU интеграция**: Продуктови и packaging баркодове
- **Validation engine**: Валидация на бизнес правила и проверки за консистентност

### 👥 **Изчерпателно управление на партньори**
- **Управление на клиенти**: Кредитни лимити, ценови групи, графици за доставка
- **Управление на доставчици**: Условия за плащане, отделения, графици за доставка
- **Multi-site поддръжка**: Множество локации на клиент
- **Schedule интеграция**: Седмични графици за доставка/поръчки

---

## Интеграционна архитектура

### Document-Driven Integration

```python
# StatusResolver управлява статус преходи
from nomenclatures.services._status_resolver import StatusResolver

# Semantic status resolution
approval_statuses = StatusResolver.get_statuses_by_semantic_type(
    document_type, 'processing'
)

# ApprovalService за одобрения
result = ApprovalService.authorize_document_transition(
    document, 'одобрена', user, comments='Одобрено след проверка'
)
```

### Service Registry Integration

```python
# Централизирано resolve-ване на услуги
from core.interfaces.service_registry import ServiceRegistry

pricing_service = ServiceRegistry.resolve('IPricingService')
product_service = ServiceRegistry.resolve('IProductService')
```

---

## Поток от данни

### 1. **Жизнен цикъл на документ за покупка**

```
1. Създай заявка за покупка
   ├─ DocumentService.create('request', ...)
   ├─ Валидация чрез ApprovalService
   ├─ Създай инстанция → Setup чрез facade → Добави редове
   └─ Статус: 'чернова' (без складови движения)

2. Одобри заявка
   ├─ service.transition_to('одобрена', comments)
   ├─ StatusResolver проверява конфигурация
   ├─ Без складови движения за заявки
   └─ Статус: 'одобрена'

3. Конвертирай в поръчка за покупка
   ├─ convert_to_order(expected_delivery_date=...)
   ├─ Създай нова PurchaseOrder с редове от заявка
   ├─ Маркирай заявката като 'конвертирана'
   └─ Статус: 'чернова' → може да се одобри

4. Завърши получена доставка
   ├─ service.transition_to('завършена', comments)
   ├─ StatusResolver: creates_inventory_movements=True
   ├─ MovementService.create_incoming_stock()
   ├─ Създай INCOMING движения за всеки ред
   ├─ Актуализирай InventoryItem кеш
   └─ Складът е актуализиран с получени стоки
```

### 2. **Система за десетична точност**

```python
from core.utils.decimal_utils import (
    round_currency, round_cost_price, round_vat_amount
)

# За дисплей/съхранение цени (2dp)
display_price = round_currency(calculation_result)

# За вътрешни себестойностни калкулации (4dp)
batch_cost = round_cost_price(batch.cost_price)

# За ДДС суми (2dp)
vat_amount = round_vat_amount(net_amount * vat_rate)
```

---

## Технологичен стек

### **Backend Framework**
- **Django 4.2+** - Web framework с ORM
- **Django REST Framework** - API разработка
- **Python 3.10+** - Основен език

### **База данни и кеширане**
- **PostgreSQL 14+** - Основна база данни с JSON поддръжка
- **Redis 6+** - Кеширане и session storage
- **Connection Pooling** - Оптимизирани database връзки

### **Frontend технологии**
- **Metronic 9 тема** - с Tailwind CSS 4
- **TypeScript** - За тип безопасност
- **Съвременен JavaScript** - ES6+ функционалности

### **Инфраструктура**
- **Docker & Docker Compose** - Контейнеризация
- **Nginx** - Reverse proxy и static файлове

---

## Архитектура за внедряване

### **Development Environment**

```yaml
# docker-compose.yml структура
services:
  web:          # Django приложение
  db:           # PostgreSQL база данни
  redis:        # Кеш и сесии
  nginx:        # Reverse proxy
```

### **Команди за разработка**

```bash
# Frontend разработка
npm run build              # Компилиране на CSS и JavaScript
npm run build:css:watch   # Наблюдение на CSS промени
npm run lint               # JavaScript/TypeScript проверка

# Django разработка
python manage.py runserver    # Development сървър
python manage.py migrate      # База данни миграции
python manage.py shell        # Django shell
```

---

## Сигурност и производителност

### **Сигурност мерки**
- Django's вградена authentication система
- Permission-базиран контрол на достъпа
- CSRF защита
- Secure cookie настройки
- Input валидация и sanitization

### **Оптимизация на производителността**
- **Database оптимизация**: Query optimization, database indexes
- **Caching стратегия**: Redis за сесии и query result кеширане
- **StatusResolver кеширане**: 1 час TTL за status lookups
- **Service Registry**: Кеширане на service instances

---

## Насоки за разработка

### **Стандарти за качество на кода**

```python
# Result Pattern използване
def business_operation() -> Result:
    try:
        # Бизнес логика тук
        return Result.success(data={'result': 'data'})
    except Exception as e:
        return Result.error('OPERATION_FAILED', str(e))

# Service Registry интеграция
from core.interfaces.service_registry import ServiceRegistry

pricing_service = ServiceRegistry.resolve('IPricingService')
result = pricing_service.calculate_line_price(product, quantity)
```

### **StatusResolver използване**

```python
# ✅ ПРАВИЛНО - Винаги използвай StatusResolver
from nomenclatures.services._status_resolver import StatusResolver

editable_statuses = StatusResolver.get_editable_statuses(document_type)
if document.status in editable_statuses:
    # Позволи редактиране

# ❌ НЕПРАВИЛНО - Никога не използвай hardcoded статуси
if document.status == 'approved':  # Избягвай това
    pass
```

### **Стратегия за тестване**

```python
# Unit тестове
- Тествай всички service методи
- Тествай Result pattern отговори
- Тествай валидационна логика
- Mock външни зависимости

# Integration тестове
- Тествай документни workflow-ове
- Тествай складови движения
- Тествай ценови калкулации
- Тествай статус преходи
```

---

## Бъдеща пътна карта

### **Краткосрочно (Q1-Q2 2025)**
- Мобилно POS приложение
- Усъвършенствани reporting dashboard-ове
- API rate limiting и throttling
- Подобрено audit логиране

### **Средносрочно (Q3-Q4 2025)**
- Multi-tenant архитектура
- Усъвършенствани анализи с ML
- Интеграция с външни системи (счетоводство, CRM)
- Автоматизирана тестова поточна линия

### **Дългосрочно (2026+)**
- Cloud-native внедряване (Kubernetes)
- Анализи в реално време със streaming данни
- AI-powered прогнозиране на търсенето
- Усъвършенствани сигурност функции (2FA, SSO)

---

## Начало

### **Development Setup**
1. Clone repository и setup virtual environment
2. Install dependencies: `pip install -r requirements.txt`
3. Setup database: `python manage.py migrate`
4. Load sample data: `python manage.py loaddata fixtures/`
5. Run development server: `python manage.py runserver`

### **Ключова документация**
- [CORE App Documentation](CORE_ПРИЛОЖЕНИЕ.md) - Основни услуги
- [NOMENCLATURES App Documentation](NOMENCLATURES_ПРИЛОЖЕНИЕ.md) - Управление на документи
- [INVENTORY App Documentation](INVENTORY_ПРИЛОЖЕНИЕ.md) - Управление на склада
- [PRICING App Documentation](PRICING_ПРИЛОЖЕНИЕ.md) - Ценови стратегии
- [PARTNERS App Documentation](PARTNERS_ПРИЛОЖЕНИЕ.md) - Управление на клиенти/доставчици
- [PRODUCTS App Documentation](PRODUCTS_ПРИЛОЖЕНИЕ.md) - Продуктов каталог
- [PURCHASES App Documentation](PURCHASES_ПРИЛОЖЕНИЕ.md) - Workflow за доставки

---

## Системни предимства

### **За бизнес потребители**
- **Склад в реално време**: Точни нива на запасите във всички локации
- **Автоматизирани workflow-ове**: Статусът на документа управлява бизнес процесите
- **Гъвкаво ценообразуване**: Поддръжка на сложни ценови стратегии
- **Изчерпателни отчети**: Анализи на печалбата и бизнес интелигентност

### **За разработчици**
- **Модулна архитектура**: Ясно разделение на задълженията
- **Консистентни API-та**: Result pattern и интерфейс-базиран дизайн
- **Service Registry Pattern**: Централизирано управление на dependencies
- **Обширна документация**: Изчерпателни ръководства за всеки компонент

### **За системни администратори**
- **Скалируемо внедряване**: Хоризонтални скалиращи възможности
- **Мониторинг и алерти**: Изчерпателен мониторинг на системното здраве
- **Сигурност функции**: Вградени най-добри сигурност практики
- **Configuration Management**: Environment-специфични конфигурации

---

*Последна актуализация: 2025-09-05*  
*Версия: 3.0*  
*Системна документация актуализирана според актуалния код*