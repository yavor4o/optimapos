{% extends 'frontend/base.html' %}
{% load i18n %}
{% load static %}
{% load mptt_tags %}

{% block title %}{{ page_title }} - {{ block.super }}{% endblock %}

{% block content %}
<div class="kt-container-fixed">

    <!-- DEBUG INFO -->
    <div class="kt-card mb-5 bg-info/10">
        <div class="kt-card-body p-4">
            <h4 class="text-info">ðŸ”§ DEBUG - Product Groups</h4>
            <p><strong>Total Groups:</strong> {{ total_count }}</p>
            <p><strong>Groups on page:</strong> {{ object_list|length }}</p>
            <p><strong>View mode:</strong> {{ view_mode }}</p>
            <div class="mt-2">
                <strong>Sample groups:</strong>
                {% for group in object_list|slice:":3" %}
                    <div>- {{ group.code }} ({{ group.name }}) - Level: {{ group.level }}</div>
                {% empty %}
                    <div class="text-warning">No groups found!</div>
                {% endfor %}
            </div>
        </div>
    </div>

    <!-- Page Header -->
    <div class="flex flex-wrap items-center lg:items-end justify-between gap-5 pb-7.5">
        <div class="flex flex-col justify-center gap-2">
            <h1 class="text-xl font-medium leading-none text-mono">
                {% trans "Product Groups" %}
            </h1>
            <div class="flex items-center gap-2 text-sm font-normal text-secondary-foreground">
                {% trans "Hierarchical product group management" %}
            </div>
        </div>

        <!-- Action Buttons -->
        <div class="flex items-center gap-2.5">
            <a class="kt-btn kt-btn-primary" href="{% url 'nomenclatures:product_groups_create' %}">
                <i class="ki-filled ki-plus"></i>
                {% trans "Add Product Group" %}
            </a>

            <!-- View Mode Toggle -->
            <div class="kt-btn-group" data-kt-buttons="true">
                <a href="?view=flat" class="kt-btn kt-btn-sm kt-btn-outline {% if view_mode == 'flat' %}active{% endif %}">
                    <i class="ki-filled ki-row-horizontal"></i>
                    {% trans "List" %}
                </a>
                <a href="?view=tree" class="kt-btn kt-btn-sm kt-btn-outline {% if view_mode == 'tree' %}active{% endif %}">
                    <i class="ki-filled ki-abstract-14"></i>
                    {% trans "Tree" %}
                </a>
            </div>
        </div>
    </div>

    <!-- Main Content Card -->
    <div class="kt-card">
        <div class="kt-card-header">
            <h3 class="kt-card-title">
                {% trans "Product Groups" %} ({{ total_count }})
            </h3>
        </div>

        <div class="kt-card-body">
            {% if view_mode == 'tree' %}
                <!-- Tree View -->
                <div class="space-y-2">
                    {% recursetree object_list %}
                        <div class="tree-node level-{{ node.level }}">
                            <div class="flex items-center gap-3 p-3 hover:bg-accent/50 rounded-lg">
                                <div class="flex items-center gap-2">
                                    <i class="ki-filled ki-abstract-14 text-muted-foreground"></i>
                                    <span class="font-bold text-primary">{{ node.code }}</span>
                                    <span class="text-muted-foreground">-</span>
                                    <span>{{ node.name }}</span>
                                    <span class="text-xs text-muted-foreground">(Level {{ node.level }})</span>
                                </div>

                                <div class="ms-auto flex items-center gap-2">
                                    {% if node.is_active %}
                                    <span class="kt-badge kt-badge-success kt-badge-sm">{% trans "Active" %}</span>
                                    {% else %}
                                    <span class="kt-badge kt-badge-warning kt-badge-sm">{% trans "Inactive" %}</span>
                                    {% endif %}

                                    <div class="kt-btn-group">
                                        <a href="{% url 'nomenclatures:product_groups_detail' node.pk %}" class="kt-btn kt-btn-sm kt-btn-icon kt-btn-ghost">
                                            <i class="ki-filled ki-eye"></i>
                                        </a>
                                        <a href="{% url 'nomenclatures:product_groups_edit' node.pk %}" class="kt-btn kt-btn-sm kt-btn-icon kt-btn-ghost">
                                            <i class="ki-filled ki-notepad-edit"></i>
                                        </a>
                                    </div>
                                </div>
                            </div>

                            {% if not node.is_leaf_node %}
                            <div class="ms-6">
                                {{ children }}
                            </div>
                            {% endif %}
                        </div>
                    {% endrecursetree %}
                </div>
            {% else %}
                <!-- Table View -->
                <div class="table-responsive">
                    <table class="kt-table kt-table-border kt-table-rounded">
                        <thead>
                            <tr>
                                <th>{% trans "Code" %}</th>
                                <th>{% trans "Name" %}</th>
                                <th>{% trans "Parent Group" %}</th>
                                <th>{% trans "Level" %}</th>
                                <th>{% trans "Status" %}</th>
                                <th>{% trans "Actions" %}</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for group in object_list %}
                            <tr>
                                <td><strong>{{ group.code }}</strong></td>
                                <td>{{ group.name }}</td>
                                <td>
                                    {% if group.parent %}
                                        {{ group.parent.name }}
                                    {% else %}
                                        <span class="text-muted-foreground">{% trans "Root Group" %}</span>
                                    {% endif %}
                                </td>
                                <td>{{ group.level }}</td>
                                <td>
                                    {% if group.is_active %}
                                        <span class="kt-badge kt-badge-success kt-badge-sm">{% trans "Active" %}</span>
                                    {% else %}
                                        <span class="kt-badge kt-badge-warning kt-badge-sm">{% trans "Inactive" %}</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <div class="kt-btn-group">
                                        <a href="{% url 'nomenclatures:product_groups_detail' group.pk %}" class="kt-btn kt-btn-sm kt-btn-icon kt-btn-ghost">
                                            <i class="ki-filled ki-eye"></i>
                                        </a>
                                        <a href="{% url 'nomenclatures:product_groups_edit' group.pk %}" class="kt-btn kt-btn-sm kt-btn-icon kt-btn-ghost">
                                            <i class="ki-filled ki-notepad-edit"></i>
                                        </a>
                                    </div>
                                </td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="6" class="text-center py-8">
                                    <div class="flex flex-col items-center">
                                        <i class="ki-filled ki-abstract-14 text-muted-foreground text-4xl mb-3"></i>
                                        <h4 class="text-muted-foreground mb-2">{% trans "No Product Groups Found" %}</h4>
                                        <p class="text-muted-foreground">{% trans "Get started by creating your first product group." %}</p>
                                        <a href="{% url 'nomenclatures:product_groups_create' %}" class="kt-btn kt-btn-primary mt-3">
                                            <i class="ki-filled ki-plus"></i>
                                            {% trans "Create First Group" %}
                                        </a>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            {% endif %}
        </div>
    </div>
</div>

<style>
.tree-node.level-0 { margin-left: 0rem; }
.tree-node.level-1 { margin-left: 1.5rem; }
.tree-node.level-2 { margin-left: 3rem; }
.tree-node.level-3 { margin-left: 4.5rem; }
.tree-node.level-4 { margin-left: 6rem; }
</style>
{% endblock %}
