{% extends 'frontend/base.html' %}
{% load i18n %}
{% load static %}

{% block title %}{{ page_title }} - {{ block.super }}{% endblock %}

{% block content %}
<div class="kt-container-fixed">

    <!-- Page Header -->
    <div class="flex flex-wrap items-center lg:items-end justify-between gap-5 pb-7.5">
        <div class="flex flex-col justify-center gap-2">
            <h1 class="text-xl font-medium leading-none text-mono">
                {% trans "Brands" %}
            </h1>
            <div class="flex items-center gap-2 text-sm font-normal text-secondary-foreground">
                {% trans "Manage product brands and manufacturers" %}
            </div>
        </div>

        <!-- Action Buttons -->
        <div class="flex items-center gap-2.5">
            <a class="kt-btn kt-btn-primary" href="{% url 'nomenclatures:brands_create' %}">
                <i class="ki-filled ki-plus"></i>
                {% trans "Add Brand" %}
            </a>
        </div>
    </div>

    <!-- Main Content Card -->
    <div class="kt-card">
        <div class="kt-card-header">
            <h3 class="kt-card-title">
                {% trans "Brands" %} ({{ total_count }})
            </h3>
        </div>

        <div class="kt-card-body">
            <div class="table-responsive">
                <table class="kt-table kt-table-border kt-table-rounded">
                    <thead>
                        <tr>
                            <th style="width: 50px;">{% trans "Logo" %}</th>
                            <th>{% trans "Code" %}</th>
                            <th>{% trans "Name" %}</th>
                            <th>{% trans "Website" %}</th>
                            <th>{% trans "Products" %}</th>
                            <th>{% trans "Status" %}</th>
                            <th style="width: 80px; text-align: right;">{% trans "Actions" %}</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for brand in brands %}
                        <tr>
                            <td>
                                {% if brand.logo %}
                                    <div style="width: 32px; height: 32px;">
                                        <img src="{{ brand.logo.url }}"
                                             alt="{{ brand.name }}"
                                             style="width: 100%; height: 100%; object-fit: contain; border-radius: 4px;">
                                    </div>
                                {% else %}
                                    <div style="width: 32px; height: 32px; background-color: #f3f4f6; border-radius: 4px; display: flex; align-items: center; justify-content: center;">
                                        <i class="ki-filled ki-picture" style="color: #9ca3af; font-size: 14px;"></i>
                                    </div>
                                {% endif %}
                            </td>
                            <td><strong class="text-primary">{{ brand.code }}</strong></td>
                            <td>{{ brand.name }}</td>
                            <td>
                                {% if brand.website %}
                                    <a href="{{ brand.website }}" target="_blank" style="color: #3b82f6; text-decoration: none;">
                                        <i class="ki-filled ki-global" style="font-size: 12px;"></i> {% trans "Visit" %}
                                    </a>
                                {% else %}
                                    <span class="text-muted-foreground">-</span>
                                {% endif %}
                            </td>
                            <td>
                                <span class="kt-badge kt-badge-outline kt-badge-sm">
                                    {{ brand.products_count|default:"0" }}
                                </span>
                            </td>
                            <td>
                                {% if brand.is_active %}
                                    <span class="kt-badge kt-badge-success kt-badge-sm">{% trans "Active" %}</span>
                                {% else %}
                                    <span class="kt-badge kt-badge-warning kt-badge-sm">{% trans "Inactive" %}</span>
                                {% endif %}
                            </td>
                            <td style="width: 80px; text-align: right; padding: 8px;">
                                <div style="display: flex; justify-content: flex-end; gap: 4px;">
                                    <button type="button"
                                            style="width: 28px; height: 28px; display: flex; align-items: center; justify-content: center; border: none; background: transparent; border-radius: 4px; cursor: pointer;"
                                            onclick="showBrandDetailModal({{ brand.pk }})"
                                            title="{% trans 'View Details' %}">
                                        <i class="ki-filled ki-eye" style="font-size: 14px; color: #6b7280;"></i>
                                    </button>
                                    <a href="{% url 'nomenclatures:brands_edit' brand.pk %}"
                                       style="width: 28px; height: 28px; display: flex; align-items: center; justify-content: center; border: none; background: transparent; border-radius: 4px; text-decoration: none;"
                                       title="{% trans 'Edit Brand' %}">
                                        <i class="ki-filled ki-notepad-edit" style="font-size: 14px; color: #6b7280;"></i>
                                    </a>
                                    <button type="button"
                                            style="width: 28px; height: 28px; display: flex; align-items: center; justify-content: center; border: none; background: transparent; border-radius: 4px; cursor: pointer;"
                                            onclick="confirmDelete('{% url 'nomenclatures:brands_delete' brand.pk %}')"
                                            title="{% trans 'Delete Brand' %}">
                                        <i class="ki-filled ki-trash" style="font-size: 14px; color: #dc3545;"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="7" class="text-center py-8">
                                <div class="flex flex-col items-center">
                                    <i class="ki-filled ki-tag text-muted-foreground text-4xl mb-3"></i>
                                    <h4 class="text-muted-foreground mb-2">{% trans "No Brands Found" %}</h4>
                                    <p class="text-muted-foreground">{% trans "Get started by creating your first brand." %}</p>
                                    <a href="{% url 'nomenclatures:brands_create' %}" class="kt-btn kt-btn-primary mt-3">
                                        <i class="ki-filled ki-plus"></i>
                                        {% trans "Create First Brand" %}
                                    </a>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Modal HTML -->
<div class="kt-modal" data-kt-modal="true" id="brandDetailModal">
    <div class="kt-modal-content" style="max-width: 500px; width: 100%; top: 15%;">
        <!-- Modal Header -->
        <div class="kt-modal-header">
            <h3 class="kt-modal-title" id="brandDetailModalTitle">
                {% trans "Brand Details" %}
            </h3>
            <button class="btn btn-sm btn-icon btn-light"
                    data-kt-modal-dismiss="true"
                    title="{% trans 'Close' %}">
                <i class="ki-filled ki-cross"></i>
            </button>
        </div>

        <!-- Modal Body -->
        <div class="kt-modal-body" style="padding-right: 8px;" id="brandDetailModalBody">
            <!-- Loading State -->
            <div id="loadingState" style="border-radius: 8px; background-color: #f1f5f9; width: 100%; flex-grow: 1; height: 280px; display: flex; flex-direction: column; align-items: center; justify-content: center;">
                <div class="spinner-border text-primary mb-3"></div>
                <div class="text-sm text-gray-600">{% trans "Loading..." %}</div>
            </div>

            <!-- Content State - hidden initially -->
            <div id="contentState" style="display: none; padding: 20px; height: 280px; overflow-y: auto;">
                <!-- Will be populated by JavaScript -->
            </div>
        </div>

        <!-- Modal Footer -->
        <div class="kt-modal-footer">
            <button type="button" class="btn btn-light" data-kt-modal-dismiss="true">
                {% trans "Close" %}
            </button>
        </div>
    </div>
</div>

<!-- JavaScript -->
<script>
window.showBrandDetailModal = async function(brandId) {
    const modalEl = document.getElementById('brandDetailModal');
    const modal = KTModal.getInstance(modalEl);
    const modalTitle = document.getElementById('brandDetailModalTitle');

    if (modal) {
        modal.show();
    }

    // Reset modal state
    document.getElementById('loadingState').style.display = 'flex';
    document.getElementById('contentState').style.display = 'none';

    try {
        const response = await fetch(`/nomenclatures/brands/${brandId}/`);
        const data = await response.json();

        if (data.success) {
            modalTitle.textContent = data.brand?.name || '{% trans "Brand Details" %}';

            // Show content, hide loading
            document.getElementById('loadingState').style.display = 'none';
            document.getElementById('contentState').style.display = 'block';

            // Build content HTML
            // в showBrandDetailModal
let html = `
  <div class="flex flex-col gap-6">

    <!-- Logo -->
    ${data.brand?.logo_url ? `
  <div style="display:flex; justify-content:center;">
    <div style="
      width: 120px; height: 120px;
      display:flex; align-items:center; justify-content:center;
      border:1px solid #e5e7eb; border-radius:8px;
      background:#fff; overflow:hidden;
      box-shadow: 0 1px 2px rgba(0,0,0,0.06);
    ">
      <img src="${data.brand.logo_url}"
           alt="${data.brand.name}"
           style="
             max-width:100%; max-height:100%;
             width:auto !important; height:auto !important;
             object-fit:contain; display:block;
           ">
    </div>
  </div>
` : '' }


    <!-- Info Grid -->
    <div class="grid grid-cols-2 gap-y-4 gap-x-6 text-sm">
      <div>
        <div class="text-gray-500 mb-1">{% trans "Code" %}</div>
        <div class="font-semibold text-gray-900">${data.brand?.code || '-'}</div>
      </div>

      <div>
        <div class="text-gray-500 mb-1">{% trans "Name" %}</div>
        <div class="font-semibold text-gray-900">${data.brand?.name || '-'}</div>
      </div>

      <div>
        <div class="text-gray-500 mb-1">{% trans "Products" %}</div>
        <div class="font-semibold text-gray-900">${data.brand?.products_count || 0}</div>
      </div>

      <div>
        <div class="text-gray-500 mb-1">{% trans "Status" %}</div>
        <div>
          ${data.brand?.is_active
            ? '<span class="px-2 py-0.5 text-xs rounded bg-green-100 text-green-700">{% trans "Active" %}</span>'
            : '<span class="px-2 py-0.5 text-xs rounded bg-yellow-100 text-yellow-700">{% trans "Inactive" %}</span>'}
        </div>
      </div>

      ${data.brand?.website ? `
      <div class="col-span-2">
        <div class="text-gray-500 mb-1">{% trans "Website" %}</div>
        <a href="${data.brand.website}" target="_blank"
           class="text-blue-600 hover:underline">${data.brand.website}</a>
      </div>` : ''}
    </div>
  </div>
`;


            html += '</div></div>';

            document.getElementById('contentState').innerHTML = html;

        } else {
            throw new Error(data.error || '{% trans "Failed to load brand details" %}');
        }
    } catch (error) {
        console.error('{% trans "Error:" %}', error);
        document.getElementById('loadingState').innerHTML = '<div class="text-danger text-center py-4">Error loading data</div>';
    }
};

window.confirmDelete = function(deleteUrl) {
    Swal.fire({
        title: "{% trans 'Are you sure?' %}",
        text: "{% trans 'This action cannot be undone!' %}",
        icon: "warning",
        showCancelButton: true,
        confirmButtonColor: "#d33",
        cancelButtonColor: "#3085d6",
        confirmButtonText: "{% trans 'Yes, delete it!' %}",
        cancelButtonText: "{% trans 'Cancel' %}"
    }).then((result) => {
        if (result.isConfirmed) {
            fetch(deleteUrl, {
                method: "POST",
                headers: {
                    "X-CSRFToken": getCookie("csrftoken"),  // ако си с CSRF
                    "X-Requested-With": "XMLHttpRequest"
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    Swal.fire(
                        "{% trans 'Deleted!' %}",
                        "{% trans 'The brand was deleted successfully.' %}",
                        "success"
                    ).then(() => {
                        window.location.reload(); // презареждаме таблицата
                    });
                } else {
                    Swal.fire("Error", data.error || "Failed to delete", "error");
                }
            })
            .catch(err => {
                Swal.fire("Error", err.message, "error");
            });
        }
    });
}

// helper за CSRF token
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
</script>
    <!-- SweetAlert2 -->
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

{% endblock %}