{% extends "admin/base_site.html" %}
{% load i18n admin_urls static %}

{% block title %}Workflow Testing - {{ document.document_number }}{% endblock %}

{% block extrahead %}
{{ block.super }}
<style>
.test-panel {
    background: #f8f9fa;
    border: 1px solid #dee2e6;
    border-radius: 4px;
    padding: 15px;
    margin: 10px 0;
}

.status-badge {
    padding: 4px 8px;
    border-radius: 4px;
    font-size: 12px;
    font-weight: bold;
}

.status-initial { background: #17a2b8; color: white; }
.status-active { background: #ffc107; color: black; }
.status-final { background: #28a745; color: white; }
.status-cancel { background: #dc3545; color: white; }

.transition-btn {
    margin: 2px;
    padding: 6px 12px;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-size: 12px;
}

.btn-primary { background: #007bff; color: white; }
.btn-success { background: #28a745; color: white; }
.btn-warning { background: #ffc107; color: black; }
.btn-danger { background: #dc3545; color: white; }

.log-entry {
    padding: 8px;
    border-left: 3px solid #007bff;
    margin: 5px 0;
    background: #f1f3f4;
}

.error-message {
    color: #dc3545;
    background: #f8d7da;
    padding: 8px;
    border-radius: 4px;
    margin: 5px 0;
}

.success-message {
    color: #155724;
    background: #d4edda;
    padding: 8px;
    border-radius: 4px;
    margin: 5px 0;
}
</style>
{% endblock %}

{% block content %}
<div class="module">
    <h1>üß™ Workflow Testing Interface</h1>
    <h2>Document: {{ document.document_number }} ({{ document.supplier.name }})</h2>
    
    <!-- Current Status Panel -->
    <div class="test-panel">
        <h3>üìã Current Status</h3>
        <p><strong>Status:</strong> 
            <span class="status-badge status-active">{{ document.status }}</span>
        </p>
        <p><strong>Document Type:</strong> {{ document.document_type.name|default:"Not set" }}</p>
        <p><strong>Requires Approval:</strong> 
            {% if document.document_type.requires_approval %}
                <span style="color: #dc3545;">‚úì Yes</span>
            {% else %}
                <span style="color: #28a745;">‚úó No</span>
            {% endif %}
        </p>
        <p><strong>Can Edit:</strong> 
            {% if can_edit %}
                <span style="color: #28a745;">‚úì Yes</span>
            {% else %}
                <span style="color: #dc3545;">‚úó No</span>
            {% endif %}
        </p>
    </div>

    <!-- Configured Statuses -->
    <div class="test-panel">
        <h3>‚öôÔ∏è Configured Workflow Statuses</h3>
        {% if workflow_info.configured_statuses %}
            <div style="display: flex; flex-wrap: wrap; gap: 10px;">
                {% for status in workflow_info.configured_statuses %}
                    <div style="border: 1px solid #ddd; padding: 10px; border-radius: 4px; min-width: 150px;">
                        <div><strong>{{ status.name }}</strong></div>
                        <div style="color: {{ status.color }};">{{ status.code }}</div>
                        <div style="font-size: 11px; color: #666;">
                            {% if status.is_initial %}INITIAL{% endif %}
                            {% if status.is_final %}FINAL{% endif %}
                            {% if status.is_cancellation %}CANCEL{% endif %}
                        </div>
                        <div style="font-size: 11px;">Order: {{ status.sort_order }}</div>
                    </div>
                {% endfor %}
            </div>
        {% else %}
            <p style="color: #dc3545;">No configured statuses found!</p>
        {% endif %}
    </div>

    <!-- Available Actions Testing -->
    <div class="test-panel">
        <h3>üé¨ Available Actions</h3>
        {% if available_actions %}
            <div id="actions-container">
                {% for action in available_actions %}
                    <div style="margin: 10px 0; padding: 10px; border: 1px solid #ddd; border-radius: 4px;">
                        <div><strong>{{ action.label }}</strong></div>
                        <div style="font-size: 12px; color: #666;">
                            Action: {{ action.action }} | Status: {{ action.status|default:"N/A" }}
                        </div>
                        <div style="font-size: 11px; color: #666; margin: 5px 0;">
                            {{ action.reason|default:"No reason provided" }}
                        </div>
                        
                        {% if action.action == "transition" %}
                            <button class="transition-btn btn-{{ action.button_style|default:"primary" }}" 
                                    onclick="testTransition('{{ action.status }}', '{{ action.label }}', {{ action.rule_id|default:"null" }})">
                                üß™ Test: {{ action.label }}
                            </button>
                        {% endif %}
                    </div>
                {% endfor %}
            </div>
        {% else %}
            <p style="color: #dc3545;">No actions available for current user!</p>
        {% endif %}
        
        <button onclick="refreshActions()" style="background: #17a2b8; color: white; border: none; padding: 6px 12px; border-radius: 4px;">
            üîÑ Refresh Actions
        </button>
    </div>

    <!-- Manual Transition Testing -->
    <div class="test-panel">
        <h3>üéØ Manual Transition Testing</h3>
        <form id="manual-transition-form">
            <div style="margin: 10px 0;">
                <label for="target-status"><strong>Target Status:</strong></label>
                <select id="target-status" style="padding: 4px; margin-left: 10px;">
                    <option value="">Select status...</option>
                    {% for status in workflow_info.configured_statuses %}
                        <option value="{{ status.code }}">{{ status.name }} ({{ status.code }})</option>
                    {% endfor %}
                </select>
            </div>
            
            <div style="margin: 10px 0;">
                <label for="comments"><strong>Comments:</strong></label><br>
                <textarea id="comments" rows="3" cols="50" placeholder="Optional comments for this transition..."></textarea>
            </div>
            
            <button type="button" onclick="executeManualTransition()" 
                    style="background: #dc3545; color: white; border: none; padding: 8px 16px; border-radius: 4px;">
                ‚ö° Execute Transition
            </button>
        </form>
    </div>

    <!-- Transition Log -->
    <div class="test-panel">
        <h3>üìä Transition Test Log</h3>
        <div id="test-log">
            <div class="log-entry">
                <strong>Ready for testing</strong> - {{ current_user.username }} - {% now "Y-m-d H:i:s" %}
            </div>
        </div>
        
        <button onclick="clearLog()" style="background: #6c757d; color: white; border: none; padding: 4px 8px; border-radius: 4px; font-size: 11px;">
            üóëÔ∏è Clear Log
        </button>
    </div>

    <!-- Approval History -->
    {% if workflow_info.approval_history %}
    <div class="test-panel">
        <h3>üìú Approval History</h3>
        {% for entry in workflow_info.approval_history %}
            <div class="log-entry">
                <strong>{{ entry.action|upper }}</strong>: {{ entry.from_status }} ‚Üí {{ entry.to_status }}<br>
                <small>By: {{ entry.actor }} | {{ entry.timestamp }}</small>
                {% if entry.comments %}
                    <div style="font-style: italic; margin-top: 5px;">{{ entry.comments }}</div>
                {% endif %}
            </div>
        {% endfor %}
    </div>
    {% endif %}

    <!-- Back Button -->
    <div style="margin: 20px 0;">
        <a href="{% url 'admin:purchases_purchaserequest_change' document.pk %}" 
           style="background: #6c757d; color: white; padding: 8px 16px; border-radius: 4px; text-decoration: none;">
            ‚Üê Back to Document
        </a>
    </div>
</div>

<script>
// Global variables
let documentId = {{ document.pk }};
let currentStatus = '{{ document.status }}';

// Test transition function
function testTransition(targetStatus, actionLabel, ruleId) {
    const comments = prompt(`Testing transition: ${actionLabel}\n\nOptional comments:`, '');
    if (comments === null) return; // User cancelled
    
    logMessage(`üß™ Testing transition to: ${targetStatus}`, 'info');
    
    fetch('{% url "admin:purchases_purchaserequest_workflow_ajax" %}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify({
            'object_id': documentId,
            'action': 'transition',
            'status': targetStatus,
            'comments': comments
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            logMessage(`‚úÖ SUCCESS: Transitioned to ${data.new_status}`, 'success');
            currentStatus = data.new_status;
            refreshActions();
        } else {
            logMessage(`‚ùå FAILED: ${data.message}`, 'error');
        }
    })
    .catch(error => {
        logMessage(`üí• ERROR: ${error}`, 'error');
    });
}

// Manual transition
function executeManualTransition() {
    const targetStatus = document.getElementById('target-status').value;
    const comments = document.getElementById('comments').value;
    
    if (!targetStatus) {
        alert('Please select a target status');
        return;
    }
    
    logMessage(`‚ö° Manual transition to: ${targetStatus}`, 'info');
    
    fetch('{% url "admin:purchases_purchaserequest_workflow_ajax" %}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify({
            'object_id': documentId,
            'action': 'transition',
            'status': targetStatus,
            'comments': comments
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            logMessage(`‚úÖ SUCCESS: Manual transition to ${data.new_status}`, 'success');
            currentStatus = data.new_status;
            refreshActions();
            // Clear form
            document.getElementById('target-status').value = '';
            document.getElementById('comments').value = '';
        } else {
            logMessage(`‚ùå FAILED: ${data.message}`, 'error');
        }
    })
    .catch(error => {
        logMessage(`üí• ERROR: ${error}`, 'error');
    });
}

// Refresh available actions
function refreshActions() {
    logMessage('üîÑ Refreshing available actions...', 'info');
    
    fetch('{% url "admin:purchases_purchaserequest_workflow_ajax" %}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify({
            'object_id': documentId,
            'action': 'get_actions'
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            logMessage(`‚úÖ Actions refreshed (${data.actions.length} available)`, 'success');
            updateActionsDisplay(data.actions);
        } else {
            logMessage(`‚ùå Failed to refresh actions`, 'error');
        }
    })
    .catch(error => {
        logMessage(`üí• ERROR: ${error}`, 'error');
    });
}

// Update actions display
function updateActionsDisplay(actions) {
    const container = document.getElementById('actions-container');
    if (!container) return;
    
    container.innerHTML = '';
    
    if (actions.length === 0) {
        container.innerHTML = '<p style="color: #dc3545;">No actions available!</p>';
        return;
    }
    
    actions.forEach(action => {
        const div = document.createElement('div');
        div.style.cssText = 'margin: 10px 0; padding: 10px; border: 1px solid #ddd; border-radius: 4px;';
        div.innerHTML = `
            <div><strong>${action.label}</strong></div>
            <div style="font-size: 12px; color: #666;">
                Action: ${action.action} | Status: ${action.status || 'N/A'}
            </div>
            <div style="font-size: 11px; color: #666; margin: 5px 0;">
                ${action.reason || 'No reason provided'}
            </div>
            ${action.action === 'transition' ? `
                <button class="transition-btn btn-${action.button_style || 'primary'}" 
                        onclick="testTransition('${action.status}', '${action.label}', ${action.rule_id || 'null'})">
                    üß™ Test: ${action.label}
                </button>
            ` : ''}
        `;
        container.appendChild(div);
    });
}

// Log message function
function logMessage(message, type = 'info') {
    const log = document.getElementById('test-log');
    const timestamp = new Date().toLocaleString();
    
    const entry = document.createElement('div');
    entry.className = 'log-entry';
    
    const colors = {
        'info': '#007bff',
        'success': '#28a745',
        'error': '#dc3545',
        'warning': '#ffc107'
    };
    
    entry.style.borderLeftColor = colors[type] || colors.info;
    entry.innerHTML = `<strong>${message}</strong> - {{ current_user.username }} - ${timestamp}`;
    
    log.insertBefore(entry, log.firstChild);
    
    // Keep only last 20 entries
    while (log.children.length > 21) { // +1 for "Ready for testing" entry
        log.removeChild(log.lastChild);
    }
}

// Clear log
function clearLog() {
    const log = document.getElementById('test-log');
    log.innerHTML = '<div class="log-entry"><strong>Log cleared</strong> - {{ current_user.username }} - ' + new Date().toLocaleString() + '</div>';
}

// Get CSRF cookie
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// Auto-refresh every 30 seconds
setInterval(refreshActions, 30000);
</script>
{% endblock %}