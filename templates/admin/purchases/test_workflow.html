<!-- templates/admin/purchases/test_workflow.html - FIXED VERSION -->

{% extends "admin/base_site.html" %}
{% load i18n admin_urls static %}

{% block title %}Workflow Testing - {{ object.document_number }}{% endblock %}

{% block extrahead %}
{{ block.super }}
<style>
.action-btn {
    padding: 8px 16px;
    margin: 5px;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    text-decoration: none;
    display: inline-block;
    font-size: 12px;
    font-weight: bold;
}
.btn-success { background: #28a745; color: white; }
.btn-primary { background: #007bff; color: white; }
.btn-warning { background: #ffc107; color: black; }
.btn-danger { background: #dc3545; color: white; }
.btn-secondary { background: #6c757d; color: white; }

.test-panel {
    background: #f8f9fa;
    padding: 15px;
    margin: 10px 0;
    border-radius: 4px;
    border: 1px solid #dee2e6;
}

.status-info {
    padding: 4px 8px;
    border-radius: 3px;
    font-size: 11px;
    font-weight: bold;
}
.status-draft { background: #6c757d; color: white; }
.status-submitted { background: #ffc107; color: black; }
.status-approved { background: #28a745; color: white; }
.status-rejected { background: #dc3545; color: white; }

.debug-info {
    background: #f0f0f0;
    padding: 10px;
    border-radius: 4px;
    font-family: monospace;
    font-size: 11px;
    margin: 10px 0;
}
</style>
{% endblock %}

{% block content %}
<div class="module">
    <h1>🧪 Interactive Workflow Testing - FIXED</h1>
    <h2>{{ object.document_number }} - {{ object.supplier.name }}</h2>

    <!-- Debug Panel -->
    <div class="test-panel">
        <h3>🐛 Debug Info</h3>
        <div class="debug-info">
            <div><strong>Current Status:</strong> {{ object.status }}</div>
            <div><strong>Document Type:</strong> {{ object.document_type.name|default:"Not set" }}</div>
            <div><strong>Available Actions Count:</strong> {{ available_actions|length }}</div>
            <div><strong>User:</strong> {{ user.username }}</div>
        </div>

        <!-- Debug Button -->
        <a href="{% url 'admin:purchases_purchaserequest_debug_workflow' object.id %}"
           class="action-btn btn-secondary">🐛 Run Debug</a>
    </div>

    <!-- Current Status Panel -->
    <div class="test-panel">
        <h3>📋 Current Status</h3>
        <p><strong>Status:</strong>
            <span class="status-info status-{{ object.status }}">{{ object.status|upper }}</span>
        </p>
        <p><strong>Can Edit:</strong>
            {% if can_edit %}
                <span style="color: green;">✓ Yes</span>
            {% else %}
                <span style="color: red;">✗ No</span>
            {% endif %}
        </p>
        <p><strong>Urgency:</strong> {{ object.get_urgency_level_display }}</p>
        <p><strong>Request Type:</strong> {{ object.get_request_type_display }}</p>
    </div>

    <!-- Available Actions Panel -->
    {% if available_actions %}
    <div class="test-panel">
        <h3>🎬 Available Actions - FIXED BUTTONS</h3>

        <!-- 🔥 FIX: Use GET method with URL parameters (simplest) -->
        {% for action in available_actions %}
            {% if action.action == "transition" %}
                <a href="{% url 'admin:purchases_purchaserequest_workflow' object.id %}?action={{ action.action }}&status={{ action.status }}"
                   class="action-btn btn-{{ action.button_style|default:'primary' }}"
                   onclick="return confirm('Execute transition: {{ action.label }}?')">
                    🚀 {{ action.label }}
                </a>
            {% endif %}
        {% endfor %}

        <hr style="margin: 15px 0;">

        <!-- 🔥 FIX: Manual form with POST (for testing both approaches) -->
        <h4>Manual POST Form:</h4>
        <form method="post" action="{% url 'admin:purchases_purchaserequest_workflow' object.id %}">
            {% csrf_token %}

            <label for="manual-action">Action:</label>
            <select name="action" id="manual-action" style="padding: 4px; margin: 0 10px;">
                <option value="transition">transition</option>
            </select>

            <label for="manual-status">Status:</label>
            <select name="status" id="manual-status" style="padding: 4px; margin: 0 10px;">
                <option value="">Choose status...</option>
                <option value="draft">Draft</option>
                <option value="submitted">Submitted</option>
                <option value="approved">Approved</option>
                <option value="rejected">Rejected</option>
                <option value="cancelled">Cancelled</option>
            </select>

            <input type="text" name="comments" placeholder="Optional comments..."
                   style="padding: 4px; margin: 0 10px; width: 200px;">

            <button type="submit" class="action-btn btn-danger"
                    onclick="return confirm('Execute POST transition?')">
                ⚡ POST Transition
            </button>
        </form>

        <!-- 🔥 Debug Actions Display -->
        <hr style="margin: 15px 0;">
        <h4>Debug: Available Actions Data</h4>
        <div class="debug-info">
            {% for action in available_actions %}
                <div style="margin: 5px 0; padding: 8px; border: 1px solid #ddd; border-radius: 3px; background: white;">
                    <strong>{{ action.label }}</strong><br>
                    <small><strong>Action:</strong> {{ action.action }} | <strong>Target:</strong> {{ action.status|default:"N/A" }}</small><br>
                    <small style="color: #666;"><strong>Reason:</strong> {{ action.reason|default:"No reason provided" }}</small>
                </div>
            {% endfor %}
        </div>
    </div>
    {% else %}
    <div class="test-panel">
        <h3>❌ No Actions Available</h3>
        <p>No workflow actions are available for the current user and document state.</p>

        <!-- Still add debug button -->
        <a href="{% url 'admin:purchases_purchaserequest_debug_workflow' object.id %}"
           class="action-btn btn-secondary">🐛 Debug Why No Actions</a>
    </div>
    {% endif %}

    <!-- Workflow Info Panel -->
    {% if workflow_info %}
    <div class="test-panel">
        <h3>⚙️ Nomenclatures Workflow Information</h3>
        <div class="debug-info">
            <div><strong>Current Status:</strong> {{ workflow_info.current_status }}</div>
            <div><strong>Available Transitions:</strong> {{ workflow_info.available_transitions|length }}</div>
            <div><strong>Configured Statuses:</strong> {{ workflow_info.configured_statuses|length }}</div>
        </div>

        {% if workflow_info.configured_statuses %}
        <h4>Configured Workflow Statuses:</h4>
        <div style="display: flex; flex-wrap: wrap; gap: 10px; margin-top: 10px;">
            {% for status in workflow_info.configured_statuses %}
                <div style="border: 1px solid #ddd; padding: 8px; border-radius: 4px;
                           background: {{ status.color|default:'#f8f9fa' }};
                           color: {% if status.color == '#ffffff' %}black{% else %}white{% endif %};">
                    <strong>{{ status.name }}</strong><br>
                    <small>{{ status.code }}</small>
                    {% if status.is_initial %}<br><small>📥 INITIAL</small>{% endif %}
                    {% if status.is_final %}<br><small>🔚 FINAL</small>{% endif %}
                    {% if status.is_cancellation %}<br><small>❌ CANCEL</small>{% endif %}
                </div>
            {% endfor %}
        </div>
        {% endif %}
    </div>
    {% endif %}

    <!-- Navigation -->
    <div class="test-panel">
        <h3>🔙 Navigation</h3>
        <a href="{% url 'admin:purchases_purchaserequest_change' object.id %}"
           class="action-btn btn-secondary">↩️ Back to Edit</a>
        <a href="{% url 'admin:purchases_purchaserequest_changelist' %}"
           class="action-btn btn-secondary">📋 Back to List</a>
    </div>
</div>

<script>
// Add some JavaScript for debugging
console.log('🧪 Workflow test page loaded');
console.log('Available actions:', {{ available_actions|length }});
console.log('Current status:', '{{ object.status }}');
</script>
{% endblock %}