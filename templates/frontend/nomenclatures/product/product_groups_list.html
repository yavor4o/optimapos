{% extends 'frontend/base.html' %}
{% load i18n %}
{% load static %}
{% load mptt_tags %}

{% block title %}{{ page_title }} - {{ block.super }}{% endblock %}

{% block content %}
<div class="kt-container-fixed">



    <!-- Page Header -->
    <div class="flex flex-wrap items-center lg:items-end justify-between gap-5 pb-7.5">
        <div class="flex flex-col justify-center gap-2">
            <h1 class="text-xl font-medium leading-none text-mono">
                {% trans "Product Groups" %}
            </h1>
            <div class="flex items-center gap-2 text-sm font-normal text-secondary-foreground">
                {% trans "Hierarchical product group management" %}
            </div>
        </div>

        <!-- Action Buttons -->
        <div class="flex items-center gap-2.5">
            <a class="kt-btn kt-btn-primary" href="{% url 'nomenclatures:product_groups_create' %}">
                <i class="ki-filled ki-plus"></i>
                {% trans "Add Product Group" %}
            </a>

            <!-- View Mode Toggle -->
            <div class="kt-btn-group" data-kt-buttons="true">
                <a href="?view=flat" class="kt-btn kt-btn-sm kt-btn-outline {% if view_mode == 'flat' %}active{% endif %}">
                    <i class="ki-filled ki-row-horizontal"></i>
                    {% trans "List" %}
                </a>
                <a href="?view=tree" class="kt-btn kt-btn-sm kt-btn-outline {% if view_mode == 'tree' %}active{% endif %}">
                    <i class="ki-filled ki-abstract-14"></i>
                    {% trans "Tree" %}
                </a>
            </div>
        </div>
    </div>

    <!-- Main Content Card -->
    <div class="kt-card">
        <div class="kt-card-header">
            <h3 class="kt-card-title">
                {% trans "Product Groups" %} ({{ total_count }})
            </h3>
        </div>

        <div class="kt-card-body">
    {% if view_mode == 'tree' %}
        <!-- Tree View -->
        <div class="space-y-2">
            {% recursetree object_list %}
                <div class="tree-node level-{{ node.level }}">
                    <div class="flex items-center gap-3 p-3 hover:bg-accent/50 rounded-lg">
                        <div class="flex items-center gap-2">
                            <i class="ki-filled ki-abstract-14 text-muted-foreground"></i>
                            <span class="font-bold text-primary">{{ node.code }}</span>
                            <span class="text-muted-foreground">-</span>
                            <span>{{ node.name }}</span>
                            <span class="text-xs text-muted-foreground">(Level {{ node.level }})</span>
                        </div>

                        <div class="ms-auto flex items-center gap-2">
                            {% if node.is_active %}
                            <span class="kt-badge kt-badge-success kt-badge-sm">{% trans "Active" %}</span>
                            {% else %}
                            <span class="kt-badge kt-badge-warning kt-badge-sm">{% trans "Inactive" %}</span>
                            {% endif %}

                            <div class="kt-btn-group">
                                <button type="button"
                                        class="kt-btn kt-btn-sm kt-btn-icon kt-btn-ghost"
                                        onclick="event.preventDefault(); openDetailModal({{ node.pk }}); return false;"
                                        title="{% trans 'View Details' %}">
                                    <i class="ki-filled ki-eye"></i>
                                </button>
                                <a href="{% url 'nomenclatures:product_groups_edit' node.pk %}" class="kt-btn kt-btn-sm kt-btn-icon kt-btn-ghost">
                                    <i class="ki-filled ki-notepad-edit"></i>
                                </a>
                            </div>
                        </div>
                    </div>

                    {% if not node.is_leaf_node %}
                    <div class="ms-6">
                        {{ children }}
                    </div>
                    {% endif %}
                </div>
            {% endrecursetree %}
        </div>
    {% else %}
        <!-- Table View -->
        <div class="table-responsive">
            <table class="kt-table kt-table-border kt-table-rounded">
                <thead>
                    <tr>
                        <th>{% trans "Code" %}</th>
                        <th>{% trans "Name" %}</th>
                        <th>{% trans "Parent Group" %}</th>
                        <th>{% trans "Level" %}</th>
                        <th>{% trans "Status" %}</th>
                        <th>{% trans "Actions" %}</th>
                    </tr>
                </thead>
                <tbody>
                    {% for group in object_list %}
                    <tr>
                        <td><strong>{{ group.code }}</strong></td>
                        <td>{{ group.name }}</td>
                        <td>
                            {% if group.parent %}
                                {{ group.parent.name }}
                            {% else %}
                                <span class="text-muted-foreground">{% trans "Root Group" %}</span>
                            {% endif %}
                        </td>
                        <td>{{ group.level }}</td>
                        <td>
                            {% if group.is_active %}
                                <span class="kt-badge kt-badge-success kt-badge-sm">{% trans "Active" %}</span>
                            {% else %}
                                <span class="kt-badge kt-badge-warning kt-badge-sm">{% trans "Inactive" %}</span>
                            {% endif %}
                        </td>
                        <td>
                            <div class="kt-btn-group">
                                <button type="button"
                                        class="kt-btn kt-btn-sm kt-btn-icon kt-btn-ghost"
                                        onclick="event.preventDefault(); openDetailModal({{ group.pk }}); return false;"
                                        title="{% trans 'View Details' %}">
                                    <i class="ki-filled ki-eye"></i>
                                </button>
                                <a href="{% url 'nomenclatures:product_groups_edit' group.pk %}" class="kt-btn kt-btn-sm kt-btn-icon kt-btn-ghost">
                                    <i class="ki-filled ki-notepad-edit"></i>
                                </a>
                            </div>
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="6" class="text-center py-8">
                            <div class="flex flex-col items-center">
                                <i class="ki-filled ki-abstract-14 text-muted-foreground text-4xl mb-3"></i>
                                <h4 class="text-muted-foreground mb-2">{% trans "No Product Groups Found" %}</h4>
                                <p class="text-muted-foreground">{% trans "Get started by creating your first product group." %}</p>
                                <a href="{% url 'nomenclatures:product_groups_create' %}" class="kt-btn kt-btn-primary mt-3">
                                    <i class="ki-filled ki-plus"></i>
                                    {% trans "Create First Group" %}
                                </a>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    {% endif %}
</div>


<!-- Modal Container с правилните класове -->
<div id="detail-modal-container" ></div>

<script>
// Product Group Modal - Native KT Metronic System

/**
 * Open product group detail modal using native KT Modal
 */
function openDetailModal(groupId) {
    console.log('Opening modal for group:', groupId);

    // Show loading
    showModalLoading();

    // AJAX заявка
    fetch(`/nomenclatures/product-groups/${groupId}/`, {
        method: 'GET',
        headers: {
            'X-Requested-With': 'XMLHttpRequest',
            'Content-Type': 'application/json',
        },
        credentials: 'same-origin'
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        return response.json();
    })
    .then(data => {
        console.log('Data received, showing modal');
        hideModalLoading();

        if (data.success) {
            // Insert modal HTML into container
            const container = document.getElementById('detail-modal-container');
            if (!container) return;

            container.innerHTML = data.html;

            // Initialize all new KT components (including modals)
            KTModal.createInstances();

            // Get the modal instance and show it
            const modalElement = container.querySelector('#product-group-modal');
            if (modalElement) {
                const modal = KTModal.getInstance(modalElement);
                if (modal) {
                    // Setup cleanup when modal hides
                    modal.on('hide', function() {
                        setTimeout(() => {
                            container.innerHTML = '';
                            document.title = document.title.replace(/ - Product Group Details$/, '');
                        }, 300);
                    });

                    // Show the modal using KT Modal API
                    modal.show();
                    console.log('Modal shown using KT Modal API');
                } else {
                    console.error('Could not get KT Modal instance');
                }
            }

            // Set page title
            if (data.title) {
                document.title = data.title;
            }

        } else {
            showErrorMessage(data.message || 'Error loading product group details');
        }
    })
    .catch(error => {
        console.error('AJAX Error:', error);
        hideModalLoading();
        showErrorMessage('Failed to load product group details. Please try again.');
    });
}

/**
 * Show loading modal using KT Modal
 */
function showModalLoading() {
    const container = document.getElementById('detail-modal-container');
    if (!container) return;

    container.innerHTML = `
        <div class="kt-modal" data-kt-modal="true" id="loading-modal">
            <div class="kt-modal-content max-w-[300px] top-[20%]">
                <div class="kt-modal-body text-center py-8">
                    <div class="flex flex-col items-center gap-4">
                        <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-primary"></div>
                        <span class="text-sm text-gray-600">Loading...</span>
                    </div>
                </div>
            </div>
        </div>
    `;

    // Initialize and show loading modal
    KTModal.createInstances();
    const loadingModalElement = container.querySelector('#loading-modal');
    const loadingModal = KTModal.getInstance(loadingModalElement);
    if (loadingModal) {
        loadingModal.show();
    }
}

/**
 * Hide loading modal
 */
function hideModalLoading() {
    const loadingModalElement = document.querySelector('#loading-modal');
    if (loadingModalElement) {
        const loadingModal = KTModal.getInstance(loadingModalElement);
        if (loadingModal) {
            loadingModal.hide();
        }
    }
}

/**
 * Show error message modal
 */
function showErrorMessage(message) {
    const container = document.getElementById('detail-modal-container');
    if (!container) {
        alert(message);
        return;
    }

    container.innerHTML = `
        <div class="kt-modal" data-kt-modal="true" id="error-modal">
            <div class="kt-modal-content max-w-[400px] top-[20%]">
                <div class="kt-modal-header">
                    <h3 class="kt-modal-title text-red-600">Error</h3>
                    <button type="button" class="kt-modal-close" aria-label="Close modal" data-kt-modal-dismiss="#error-modal">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M18 6 6 18"></path>
                            <path d="m6 6 12 12"></path>
                        </svg>
                    </button>
                </div>
                <div class="kt-modal-body">
                    <div class="flex items-center gap-3 p-4 bg-red-50 rounded-lg">
                        <i class="ki-filled ki-information-2 text-red-500 text-xl"></i>
                        <div>
                            <p class="text-sm text-red-700">${message}</p>
                        </div>
                    </div>
                </div>
                <div class="kt-modal-footer">
                    <button type="button" class="kt-btn kt-btn-primary" data-kt-modal-dismiss="#error-modal">
                        Close
                    </button>
                </div>
            </div>
        </div>
    `;

    // Initialize and show error modal
    KTModal.createInstances();
    const errorModalElement = container.querySelector('#error-modal');
    const errorModal = KTModal.getInstance(errorModalElement);
    if (errorModal) {
        errorModal.on('hide', function() {
            setTimeout(() => {
                container.innerHTML = '';
            }, 300);
        });
        errorModal.show();
    }
}

// Initialize on page load
document.addEventListener('DOMContentLoaded', function() {
    console.log('Initializing KT Modal system...');

    // Ensure modal container exists
    if (!document.getElementById('detail-modal-container')) {
        const container = document.createElement('div');
        container.id = 'detail-modal-container';
        document.body.appendChild(container);
    }

    // Initialize all KT Modals on the page
    KTModal.init();
    console.log('KT Modal system initialized');
});
</script>

{% endblock %}
