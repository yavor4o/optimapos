{% extends 'frontend/base.html' %}
{% load i18n %}
{% load static %}
{% load mptt_tags %}

{% block title %}{{ page_title }} - {{ block.super }}{% endblock %}

{% block content %}
<div class="kt-container-fixed">



    <!-- Page Header -->
    <div class="flex flex-wrap items-center lg:items-end justify-between gap-5 pb-7.5">
        <div class="flex flex-col justify-center gap-2">
            <h1 class="text-xl font-medium leading-none text-mono">
                {% trans "Product Groups" %}
            </h1>
            <div class="flex items-center gap-2 text-sm font-normal text-secondary-foreground">
                {% trans "Hierarchical product group management" %}
            </div>
        </div>

        <!-- Action Buttons -->
        <div class="flex items-center gap-2.5">
            <a class="kt-btn kt-btn-primary" href="{% url 'nomenclatures:product_groups_create' %}">
                <i class="ki-filled ki-plus"></i>
                {% trans "Add Product Group" %}
            </a>

            <!-- View Mode Toggle -->
            <div class="kt-btn-group" data-kt-buttons="true">
                <a href="?view=flat" class="kt-btn kt-btn-sm kt-btn-outline {% if view_mode == 'flat' %}active{% endif %}">
                    <i class="ki-filled ki-row-horizontal"></i>
                    {% trans "List" %}
                </a>
                <a href="?view=tree" class="kt-btn kt-btn-sm kt-btn-outline {% if view_mode == 'tree' %}active{% endif %}">
                    <i class="ki-filled ki-abstract-14"></i>
                    {% trans "Tree" %}
                </a>
            </div>
        </div>
    </div>

    <!-- Main Content Card -->
    <div class="kt-card">
        <div class="kt-card-header">
            <h3 class="kt-card-title">
                {% trans "Product Groups" %} ({{ total_count }})
            </h3>
        </div>

        <div class="kt-card-body">
    {% if view_mode == 'tree' %}
        <!-- Tree View -->
        <div class="space-y-2">
            {% recursetree object_list %}
                <div class="tree-node level-{{ node.level }}">
                    <div class="flex items-center gap-3 p-3 hover:bg-accent/50 rounded-lg">
                        <div class="flex items-center gap-2">
                            <i class="ki-filled ki-abstract-14 text-muted-foreground"></i>
                            <span class="font-bold text-primary">{{ node.code }}</span>
                            <span class="text-muted-foreground">-</span>
                            <span>{{ node.name }}</span>
                            <span class="text-xs text-muted-foreground">(Level {{ node.level }})</span>
                        </div>

                        <div class="ms-auto flex items-center gap-2">
                            {% if node.is_active %}
                            <span class="kt-badge kt-badge-success kt-badge-sm">{% trans "Active" %}</span>
                            {% else %}
                            <span class="kt-badge kt-badge-warning kt-badge-sm">{% trans "Inactive" %}</span>
                            {% endif %}

                            <div class="kt-btn-group">
                                <button type="button"
                                        class="kt-btn kt-btn-sm kt-btn-icon kt-btn-ghost"
                                        onclick="event.preventDefault(); openDetailModal({{ node.pk }}); return false;"
                                        title="{% trans 'View Details' %}">
                                    <i class="ki-filled ki-eye"></i>
                                </button>
                                <a href="{% url 'nomenclatures:product_groups_edit' node.pk %}" class="kt-btn kt-btn-sm kt-btn-icon kt-btn-ghost">
                                    <i class="ki-filled ki-notepad-edit"></i>
                                </a>
                            </div>
                        </div>
                    </div>

                    {% if not node.is_leaf_node %}
                    <div class="ms-6">
                        {{ children }}
                    </div>
                    {% endif %}
                </div>
            {% endrecursetree %}
        </div>
    {% else %}
        <!-- Table View -->
        <div class="table-responsive">
            <table class="kt-table kt-table-border kt-table-rounded">
                <thead>
                    <tr>
                        <th>{% trans "Code" %}</th>
                        <th>{% trans "Name" %}</th>
                        <th>{% trans "Parent Group" %}</th>
                        <th>{% trans "Level" %}</th>
                        <th>{% trans "Status" %}</th>
                        <th>{% trans "Actions" %}</th>
                    </tr>
                </thead>
                <tbody>
                    {% for group in object_list %}
                    <tr>
                        <td><strong>{{ group.code }}</strong></td>
                        <td>{{ group.name }}</td>
                        <td>
                            {% if group.parent %}
                                {{ group.parent.name }}
                            {% else %}
                                <span class="text-muted-foreground">{% trans "Root Group" %}</span>
                            {% endif %}
                        </td>
                        <td>{{ group.level }}</td>
                        <td>
                            {% if group.is_active %}
                                <span class="kt-badge kt-badge-success kt-badge-sm">{% trans "Active" %}</span>
                            {% else %}
                                <span class="kt-badge kt-badge-warning kt-badge-sm">{% trans "Inactive" %}</span>
                            {% endif %}
                        </td>
                        <td>
                            <div class="kt-btn-group">
                                <button type="button"
                                        class="kt-btn kt-btn-sm kt-btn-icon kt-btn-ghost"
                                        onclick="event.preventDefault(); openDetailModal({{ group.pk }}); return false;"
                                        title="{% trans 'View Details' %}">
                                    <i class="ki-filled ki-eye"></i>
                                </button>
                                <a href="{% url 'nomenclatures:product_groups_edit' group.pk %}" class="kt-btn kt-btn-sm kt-btn-icon kt-btn-ghost">
                                    <i class="ki-filled ki-notepad-edit"></i>
                                </a>
                            </div>
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="6" class="text-center py-8">
                            <div class="flex flex-col items-center">
                                <i class="ki-filled ki-abstract-14 text-muted-foreground text-4xl mb-3"></i>
                                <h4 class="text-muted-foreground mb-2">{% trans "No Product Groups Found" %}</h4>
                                <p class="text-muted-foreground">{% trans "Get started by creating your first product group." %}</p>
                                <a href="{% url 'nomenclatures:product_groups_create' %}" class="kt-btn kt-btn-primary mt-3">
                                    <i class="ki-filled ki-plus"></i>
                                    {% trans "Create First Group" %}
                                </a>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    {% endif %}
</div>

<!-- Modal Container -->
<div id="detail-modal-container"></div>

<script>
// Product Group Modal JavaScript Functions
// Add this to your list template or base template

/**
 * Open product group detail modal via AJAX
 * @param {number} groupId - The product group ID
 */
function openDetailModal(groupId) {
    // Show loading indicator
    showModalLoading();

    // Make AJAX request to get modal HTML
    fetch(`/nomenclatures/product-groups/${groupId}/`, {
        method: 'GET',
        headers: {
            'X-Requested-With': 'XMLHttpRequest',
            'Content-Type': 'application/json',
        },
        credentials: 'same-origin'  // Include CSRF cookies
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        return response.json();
    })
    .then(data => {
        hideModalLoading();

        if (data.success) {
            // Insert modal HTML into container
            const container = document.getElementById('detail-modal-container');
            container.innerHTML = data.html;

            // Set page title if provided
            if (data.title) {
                document.title = data.title;
            }

            // Add modal event listeners
            setupModalEventListeners();

            // Focus on close button for accessibility
            const closeBtn = container.querySelector('.kt-modal-close');
            if (closeBtn) {
                closeBtn.focus();
            }

        } else {
            // Show error message
            showErrorMessage(data.message || 'Error loading product group details');
        }
    })
    .catch(error => {
        hideModalLoading();
        console.error('Error loading modal:', error);
        showErrorMessage('Failed to load product group details. Please try again.');
    });
}

/**
 * Close the detail modal
 */
function closeDetailModal() {
    const container = document.getElementById('detail-modal-container');
    if (container) {
        // Add fade out animation
        const modal = container.querySelector('#product-group-modal');
        if (modal) {
            modal.style.opacity = '0';
            modal.style.transform = 'scale(0.95)';

            // Remove after animation
            setTimeout(() => {
                container.innerHTML = '';
                // Restore original page title if needed
                document.title = document.title.replace(/ - Product Group Details$/, '');
            }, 200);
        } else {
            container.innerHTML = '';
        }
    }
}

/**
 * Setup event listeners for modal
 */
function setupModalEventListeners() {
    const modal = document.getElementById('product-group-modal');
    if (!modal) return;

    // Close on ESC key
    document.addEventListener('keydown', function escHandler(e) {
        if (e.key === 'Escape') {
            closeDetailModal();
            document.removeEventListener('keydown', escHandler);
        }
    });

    // Close on backdrop click
    modal.addEventListener('click', function(e) {
        if (e.target === modal) {
            closeDetailModal();
        }
    });

    // Prevent modal dialog clicks from closing modal
    const modalContent = modal.querySelector('.kt-modal-content');
    if (modalContent) {
        modalContent.addEventListener('click', function(e) {
            e.stopPropagation();
        });
    }
}

/**
 * Show loading state in modal container
 */
function showModalLoading() {
    const container = document.getElementById('detail-modal-container');
    if (!container) return;

    container.innerHTML = `
        <div class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50">
            <div class="kt-modal kt-modal-center max-w-md w-full mx-4">
                <div class="kt-modal-content">
                    <div class="kt-modal-body text-center py-8">
                        <div class="flex flex-col items-center gap-4">
                            <div class="kt-spinner kt-spinner-primary"></div>
                            <span class="text-sm text-gray-600">Loading product group details...</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    `;
}

/**
 * Hide modal loading state
 */
function hideModalLoading() {
    // Loading will be replaced by actual modal content
    // This function exists for consistency
}

/**
 * Show error message
 * @param {string} message - Error message to display
 */
function showErrorMessage(message) {
    const container = document.getElementById('detail-modal-container');
    if (!container) {
        alert(message); // Fallback
        return;
    }

    container.innerHTML = `
        <div class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50">
            <div class="kt-modal kt-modal-center max-w-md w-full mx-4">
                <div class="kt-modal-content">
                    <div class="kt-modal-header">
                        <div class="kt-modal-title">
                            <h3 class="text-lg font-semibold text-red-600">Error</h3>
                        </div>
                        <button type="button" class="kt-modal-close" onclick="closeDetailModal()">
                            <i class="ki-filled ki-cross"></i>
                        </button>
                    </div>
                    <div class="kt-modal-body">
                        <div class="flex items-center gap-3 p-4 bg-red-50 rounded-lg">
                            <i class="ki-filled ki-information-2 text-red-500 text-xl"></i>
                            <div>
                                <p class="text-sm text-red-700">${message}</p>
                            </div>
                        </div>
                    </div>
                    <div class="kt-modal-footer">
                        <button type="button" class="kt-btn kt-btn-primary" onclick="closeDetailModal()">
                            Close
                        </button>
                    </div>
                </div>
            </div>
        </div>
    `;

    // Setup event listeners for error modal
    setupModalEventListeners();
}

// Initialize on page load
document.addEventListener('DOMContentLoaded', function() {
    // Ensure modal container exists
    if (!document.getElementById('detail-modal-container')) {
        const container = document.createElement('div');
        container.id = 'detail-modal-container';
        document.body.appendChild(container);
    }
});
</script>

{% endblock %}
