{% extends "admin/base_site.html" %}
{% load i18n admin_urls static admin_modify %}

{% block title %}{{ title }} | {{ site_title|default:_('Django site admin') }}{% endblock %}

{% block extrahead %}
{{ block.super }}
<style>
.workflow-form {
    max-width: 1200px;
    margin: 20px auto;
}

.form-section {
    background: white;
    margin-bottom: 20px;
    padding: 20px;
    border-radius: 4px;
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
}

.form-section h3 {
    margin-top: 0;
    color: #417690;
    border-bottom: 1px solid #e1e4e8;
    padding-bottom: 10px;
}

.form-row {
    margin-bottom: 15px;
    display: flex;
    gap: 15px;
}

.form-field {
    flex: 1;
}

.form-field label {
    display: block;
    margin-bottom: 5px;
    font-weight: bold;
}

.form-field input, .form-field select, .form-field textarea {
    width: 100%;
    padding: 8px;
    border: 1px solid #ddd;
    border-radius: 4px;
}

.lines-table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 10px;
}

.lines-table th, .lines-table td {
    padding: 8px;
    border: 1px solid #ddd;
    text-align: left;
}

.lines-table th {
    background-color: #f8f9fa;
}

.lines-table input, .lines-table select {
    width: 100%;
    border: none;
    padding: 4px;
}

.btn {
    padding: 8px 16px;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    text-decoration: none;
    display: inline-block;
}

.btn-primary {
    background-color: #007cba;
    color: white;
}

.btn-success {
    background-color: #28a745;
    color: white;
}

.btn-danger {
    background-color: #dc3545;
    color: white;
}

.btn-secondary {
    background-color: #6c757d;
    color: white;
}

.error {
    color: #dc3545;
    margin-top: 5px;
}
</style>
{% endblock %}

{% block content %}
<div class="workflow-form">
    <h1>{{ title }}</h1>

    <form method="post" id="workflow-form">
        {% csrf_token %}

        <!-- Basic Information -->
        <div class="form-section">
            <h3>{% trans "Request Information" %}</h3>

            <div class="form-row">
                <div class="form-field">
                    <label for="location">{% trans "Location" %} *</label>
                    <select name="location" id="location" required>
                        <option value="">{% trans "Select location..." %}</option>
                        {% for location in locations %}
                        <option value="{{ location.pk }}">{{ location.code }} - {{ location.name }}</option>
                        {% endfor %}
                    </select>
                </div>

                <div class="form-field">
                    <label for="supplier">{% trans "Supplier" %}</label>
                    <select name="supplier" id="supplier">
                        <option value="">{% trans "Select supplier..." %}</option>
                        {% for supplier in suppliers %}
                        <option value="{{ supplier.pk }}">{{ supplier.code }} - {{ supplier.name }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>

            <div class="form-row">
                <div class="form-field">
                    <label for="priority">{% trans "Priority" %}</label>
                    <select name="priority" id="priority">
                        {% for value, display in priorities %}
                        <option value="{{ value }}" {% if value == 'normal' %}selected{% endif %}>{{ display }}</option>
                        {% endfor %}
                    </select>
                </div>

                <div class="form-field">
                    <label for="required_by_date">{% trans "Required By Date" %}</label>
                    <input type="date" name="required_by_date" id="required_by_date">
                </div>
            </div>

            <div class="form-row">
                <div class="form-field">
                    <label for="notes">{% trans "Notes" %}</label>
                    <textarea name="notes" id="notes" rows="3"></textarea>
                </div>
            </div>
        </div>

        <!-- Product Lines -->
        <div class="form-section">
            <h3>{% trans "Product Lines" %}</h3>

            <button type="button" class="btn btn-success" onclick="addLine()">
                {% trans "Add Product Line" %}
            </button>

            <table class="lines-table" id="lines-table">
                <thead>
                    <tr>
                        <th>{% trans "Product" %}</th>
                        <th>{% trans "Quantity" %}</th>
                        <th>{% trans "Unit" %}</th>
                        <th>{% trans "Estimated Price" %}</th>
                        <th>{% trans "Notes" %}</th>
                        <th>{% trans "Actions" %}</th>
                    </tr>
                </thead>
                <tbody id="lines-tbody">
                    <!-- Lines will be added here dynamically -->
                </tbody>
            </table>
        </div>

        <!-- Submit -->
        <div class="form-section">
            <button type="submit" class="btn btn-primary">
                {% trans "Create Purchase Request" %}
            </button>
            <a href="{% url 'admin:purchases_purchaserequest_changelist' %}" class="btn btn-secondary">
                {% trans "Cancel" %}
            </a>
        </div>

        <!-- Hidden field for JSON data -->
        <input type="hidden" name="lines_data" id="lines_data">
    </form>
</div>

<script>
let lineCounter = 0;

// Product and Unit data for easy access
const productData = {
    {% for product in products %}
    {{ product.pk }}: {
        'pk': {{ product.pk }},
        'code': '{{ product.code|escapejs }}',
        'name': '{{ product.name|escapejs }}',
        'base_unit': {% if product.base_unit %}{{ product.base_unit.pk }}{% else %}null{% endif %}
    }{% if not forloop.last %},{% endif %}
    {% endfor %}
};

const unitData = {
    {% for unit in units %}
    {{ unit.pk }}: {
        'pk': {{ unit.pk }},
        'code': '{{ unit.code|escapejs }}',
        'name': '{{ unit.name|escapejs }}'
    }{% if not forloop.last %},{% endif %}
    {% endfor %}
};

function addLine() {
    lineCounter++;
    const tbody = document.getElementById('lines-tbody');
    const row = document.createElement('tr');
    row.id = `line-${lineCounter}`;

    row.innerHTML = `
        <td>
            <select name="product_${lineCounter}" id="product_${lineCounter}" onchange="onProductChange(${lineCounter})">
                <option value="">{% trans "Select product..." %}</option>
                {% for product in products %}
                <option value="{{ product.pk }}">{{ product.code }} - {{ product.name }}</option>
                {% endfor %}
            </select>
        </td>
        <td>
            <input type="number" name="quantity_${lineCounter}" id="quantity_${lineCounter}"
                   step="0.001" min="0.001" placeholder="0.000">
        </td>
        <td>
            <select name="unit_${lineCounter}" id="unit_${lineCounter}">
                <option value="">{% trans "Select unit..." %}</option>
                {% for unit in units %}
                <option value="{{ unit.pk }}">{{ unit.code }} - {{ unit.name }}</option>
                {% endfor %}
            </select>
        </td>
        <td>
            <input type="number" name="estimated_price_${lineCounter}" id="estimated_price_${lineCounter}"
                   step="0.01" min="0" placeholder="0.00">
        </td>
        <td>
            <input type="text" name="notes_${lineCounter}" id="notes_${lineCounter}"
                   placeholder="{% trans 'Additional notes...' %}">
        </td>
        <td>
            <button type="button" class="btn btn-danger" onclick="removeLine(${lineCounter})">
                {% trans "Remove" %}
            </button>
        </td>
    `;

    tbody.appendChild(row);
}

function removeLine(lineId) {
    const row = document.getElementById(`line-${lineId}`);
    if (row) {
        row.remove();
    }
}

function onProductChange(lineId) {
    const productSelect = document.getElementById(`product_${lineId}`);
    const unitSelect = document.getElementById(`unit_${lineId}`);
    const productId = productSelect.value;

    if (productId && productData[productId] && productData[productId].base_unit) {
        // Auto-select base unit if available
        unitSelect.value = productData[productId].base_unit;

        // Optional: Get product info via AJAX for additional details
        getProductInfo(productId, lineId);
    }
}

function getProductInfo(productId, lineId) {
    // Make AJAX call to get product information and auto-fill estimated price
    fetch(`{% url 'admin:purchases_purchaserequest_ajax_product' %}?product_id=${productId}`)
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                console.error('Product info error:', data.error);
            } else {
                console.log('Product info:', data);

                // Auto-fill estimated price if available
                if (data.cost_price) {
                    const priceInput = document.getElementById(`estimated_price_${lineId}`);
                    if (priceInput) {
                        priceInput.value = data.cost_price;
                    }
                }
            }
        })
        .catch(error => {
            console.error('Error fetching product info:', error);
        });
}

// Form submission handler
document.getElementById('workflow-form').addEventListener('submit', function(e) {
    const linesData = [];
    const tbody = document.getElementById('lines-tbody');
    const rows = tbody.getElementsByTagName('tr');

    for (let i = 0; i < rows.length; i++) {
        const row = rows[i];
        const productSelect = row.querySelector('select[name^="product_"]');
        const quantityInput = row.querySelector('input[name^="quantity_"]');
        const unitSelect = row.querySelector('select[name^="unit_"]');
        const estimatedPriceInput = row.querySelector('input[name^="estimated_price_"]');
        const notesInput = row.querySelector('input[name^="notes_"]');

        const productId = productSelect ? productSelect.value : '';
        const quantity = quantityInput ? quantityInput.value : '';
        const unitId = unitSelect ? unitSelect.value : '';
        const estimatedPrice = estimatedPriceInput ? estimatedPriceInput.value : '';
        const notes = notesInput ? notesInput.value : '';

        if (productId && quantity) {
            linesData.push({
                product_id: productId,
                quantity: quantity,
                unit_id: unitId,
                estimated_price: estimatedPrice,
                notes: notes
            });
        }
    }

    // Validate that we have at least one line
    if (linesData.length === 0) {
        e.preventDefault();
        alert('{% trans "Please add at least one product line." %}');
        return false;
    }

    // Set the JSON data
    document.getElementById('lines_data').value = JSON.stringify(linesData);
});

// Add initial line
document.addEventListener('DOMContentLoaded', function() {
    addLine();
});
</script>
{% endblock %}