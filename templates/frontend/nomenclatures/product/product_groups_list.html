{% extends 'frontend/base.html' %}
{% load i18n %}
{% load static %}
{% load mptt_tags %}

{% block title %}{{ page_title }} - {{ block.super }}{% endblock %}

{% block content %}
<div class="kt-container-fixed">

    <!-- Page Header -->
    <div class="flex flex-wrap items-center lg:items-end justify-between gap-5 pb-7.5">
        <div class="flex flex-col justify-center gap-2">
            <h1 class="text-xl font-medium leading-none text-mono">
                {% trans "Product Groups" %}
            </h1>
            <div class="flex items-center gap-2 text-sm font-normal text-secondary-foreground">
                {% trans "Hierarchical product group management" %}
            </div>
        </div>

        <!-- Action Buttons -->
        <div class="flex items-center gap-2.5">
            <a class="kt-btn kt-btn-primary" href="{% url 'nomenclatures:product_groups_create' %}">
                <i class="ki-filled ki-plus"></i>
                {% trans "Add Product Group" %}
            </a>

            <!-- View Mode Toggle -->
            <div class="kt-btn-group" data-kt-buttons="true">
                <a href="?view=flat" class="kt-btn kt-btn-sm kt-btn-outline {% if view_mode == 'flat' %}active{% endif %}">
                    <i class="ki-filled ki-row-horizontal"></i>
                    {% trans "List" %}
                </a>
                <a href="?view=tree" class="kt-btn kt-btn-sm kt-btn-outline {% if view_mode == 'tree' %}active{% endif %}">
                    <i class="ki-filled ki-abstract-14"></i>
                    {% trans "Tree" %}
                </a>
            </div>
        </div>
    </div>

    <!-- Main Content Card -->
    <div class="kt-card">
        <div class="kt-card-header">
            <h3 class="kt-card-title">
                {% trans "Product Groups" %} ({{ total_count }})
            </h3>
        </div>

        <div class="kt-card-body">
            {% if view_mode == 'tree' %}
                <!-- Tree View -->
                <div class="space-y-2">
                    {% recursetree object_list %}
                        <div class="tree-node level-{{ node.level }}">
                            <div class="flex items-center gap-3 p-3 hover:bg-accent/50 rounded-lg">
                                <div class="flex items-center gap-2">
                                    <i class="ki-filled ki-abstract-14 text-muted-foreground"></i>
                                    <span class="font-bold text-primary">{{ node.code }}</span>
                                    <span class="text-muted-foreground">-</span>
                                    <span>{{ node.name }}</span>
                                    <span class="text-xs text-muted-foreground">(Level {{ node.level }})</span>
                                </div>

                                <div class="ms-auto flex items-center gap-2">
                                    {% if node.is_active %}
                                    <span class="kt-badge kt-badge-success kt-badge-sm">{% trans "Active" %}</span>
                                    {% else %}
                                    <span class="kt-badge kt-badge-warning kt-badge-sm">{% trans "Inactive" %}</span>
                                    {% endif %}

                                    <div class="kt-btn-group">
                                        <button type="button"
                                                class="kt-btn kt-btn-sm kt-btn-icon kt-btn-ghost"
                                                onclick="showGroupDetailModal({{ node.pk }})"
                                                title="{% trans 'View Details' %}">
                                            <i class="ki-filled ki-eye"></i>
                                        </button>
                                        <a href="{% url 'nomenclatures:product_groups_edit' node.pk %}" class="kt-btn kt-btn-sm kt-btn-icon kt-btn-ghost">
                                            <i class="ki-filled ki-notepad-edit"></i>
                                        </a>
                                    </div>
                                </div>
                            </div>

                            {% if not node.is_leaf_node %}
                            <div class="ms-6">
                                {{ children }}
                            </div>
                            {% endif %}
                        </div>
                    {% endrecursetree %}
                </div>
            {% else %}
                <!-- Table View -->
                <div class="table-responsive">
                    <table class="kt-table kt-table-border kt-table-rounded">
                        <thead>
                            <tr>
                                <th>{% trans "Code" %}</th>
                                <th>{% trans "Name" %}</th>
                                <th>{% trans "Parent Group" %}</th>
                                <th>{% trans "Level" %}</th>
                                <th>{% trans "Status" %}</th>
                                <th>{% trans "Actions" %}</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for group in object_list %}
                            <tr>
                                <td><strong>{{ group.code }}</strong></td>
                                <td>{{ group.name }}</td>
                                <td>
                                    {% if group.parent %}
                                        {{ group.parent.name }}
                                    {% else %}
                                        <span class="text-muted-foreground">{% trans "Root Group" %}</span>
                                    {% endif %}
                                </td>
                                <td>{{ group.level }}</td>
                                <td>
                                    {% if group.is_active %}
                                        <span class="kt-badge kt-badge-success kt-badge-sm">{% trans "Active" %}</span>
                                    {% else %}
                                        <span class="kt-badge kt-badge-warning kt-badge-sm">{% trans "Inactive" %}</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <div class="kt-btn-group">
                                        <button type="button"
                                                class="kt-btn kt-btn-sm kt-btn-icon kt-btn-ghost"
                                                onclick="showGroupDetailModal({{ group.pk }})"
                                                title="{% trans 'View Details' %}">
                                            <i class="ki-filled ki-eye"></i>
                                        </button>
                                        <a href="{% url 'nomenclatures:product_groups_edit' group.pk %}" class="kt-btn kt-btn-sm kt-btn-icon kt-btn-ghost">
                                            <i class="ki-filled ki-notepad-edit"></i>
                                        </a>
                                    </div>
                                </td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="6" class="text-center py-8">
                                    <div class="flex flex-col items-center">
                                        <i class="ki-filled ki-abstract-14 text-muted-foreground text-4xl mb-3"></i>
                                        <h4 class="text-muted-foreground mb-2">{% trans "No Product Groups Found" %}</h4>
                                        <p class="text-muted-foreground">{% trans "Get started by creating your first product group." %}</p>
                                        <a href="{% url 'nomenclatures:product_groups_create' %}" class="kt-btn kt-btn-primary mt-3">
                                            <i class="ki-filled ki-plus"></i>
                                            {% trans "Create First Group" %}
                                        </a>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Detail Modal -->
<div id="groupDetailModal" class="modal fade" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="groupDetailModalTitle">{% trans "Product Group Details" %}</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="{% trans 'Close' %}"></button>
            </div>
            <div class="modal-body" id="groupDetailModalBody">
                <div class="d-flex justify-content-center py-4">
                    <div class="spinner-border" role="status">
                        <span class="visually-hidden">{% trans "Loading..." %}</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
// Product Group Detail Modal Functions
async function showGroupDetailModal(groupId) {
    const modal = new bootstrap.Modal(document.getElementById('groupDetailModal'));
    const modalTitle = document.getElementById('groupDetailModalTitle');
    const modalBody = document.getElementById('groupDetailModalBody');

    // Show loading state
    modalTitle.textContent = '{% trans "Loading..." %}';
    modalBody.innerHTML = `
        <div class="d-flex justify-content-center py-4">
            <div class="spinner-border" role="status">
                <span class="visually-hidden">{% trans "Loading..." %}</span>
            </div>
        </div>
    `;

    modal.show();

    try {
        const response = await fetch(`{% url 'nomenclatures:product_groups_detail_modal' 0 %}`.replace('0', groupId));
        const data = await response.json();

        if (data.success) {
            modalTitle.textContent = data.title;
            modalBody.innerHTML = data.html;
        } else {
            throw new Error(data.error || '{% trans "Failed to load group details" %}');
        }
    } catch (error) {
        console.error('Error loading group details:', error);
        modalBody.innerHTML = `
            <div class="alert alert-danger" role="alert">
                <i class="ki-filled ki-information-5"></i>
                {% trans "Error loading group details. Please try again." %}
            </div>
        `;
    }
}

// Confirm delete function
function confirmDelete(deleteUrl) {
    if (confirm('{% trans "Are you sure you want to delete this product group?" %}')) {
        window.location.href = deleteUrl;
    }
}
</script>
{% endblock %}