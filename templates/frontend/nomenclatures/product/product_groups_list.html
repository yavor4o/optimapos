{% extends 'frontend/base.html' %}
{% load i18n %}
{% load static %}
{% load mptt_tags %}

{% block title %}{{ page_title }} - {{ block.super }}{% endblock %}

{% block extra_js %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
{% endblock %}

{% block extra_css %}
{% endblock %}

{% block content %}
<div class="kt-container-fixed">

    <!-- Page Header -->
    <div class="flex flex-wrap items-center lg:items-end justify-between gap-5 pb-7.5">
        <div class="flex flex-col justify-center gap-2">
            <h1 class="text-xl font-medium leading-none text-mono">
                {% trans "Product Groups" %}
            </h1>
            <div class="flex items-center gap-2 text-sm font-normal text-secondary-foreground">
                {% trans "Hierarchical product group management" %}
            </div>
        </div>

        <!-- Action Buttons -->
        <div class="flex items-center gap-2.5">
            <a class="kt-btn kt-btn-primary" href="{% url 'nomenclatures:product_groups_create' %}">
                <i class="ki-filled ki-plus"></i>
                {% trans "Add Product Group" %}
            </a>

            <!-- View Mode Toggle -->
            <div class="kt-btn-group" data-kt-buttons="true">
                <a href="{% url 'nomenclatures:product_groups' %}?view=flat" class="kt-btn kt-btn-sm kt-btn-outline {% if view_mode == 'flat' %}active{% endif %}">
                    <i class="ki-filled ki-row-horizontal"></i>
                    {% trans "List" %}
                </a>
                <a href="{% url 'nomenclatures:product_groups' %}?view=tree" class="kt-btn kt-btn-sm kt-btn-outline {% if view_mode == 'tree' %}active{% endif %}">
                    <i class="ki-filled ki-abstract-14"></i>
                    {% trans "Tree" %}
                </a>
            </div>
        </div>
    </div>

    <!-- Main Content Card -->
    <div class="kt-card">
        <div class="kt-card-header">
            <h3 class="kt-card-title">
                {% trans "Product Groups" %} ({{ total_count }})
            </h3>
        </div>

        <div class="kt-card-body">
            <!-- Load SortableJS inline for Tailwind version -->
            <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js" integrity="sha512-Eezs+g9Lq4TCCq0wae01s9PuNWzHYoCMkE97e2qdkYthpI0pzC3UGB03lgEHn2XM85hDOUF6qgqqszs+iXU4UA==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>

            {% if view_mode == 'tree' %}
                <!-- Tree View with Additional Info -->
                <div class="kt-menu flex flex-col grow gap-1">
                    {% for group in object_list %}
                        {% if group.level == 0 %}
                            <div class="kt-menu-item">
                        {% elif group.level == 1 %}
                            <div class="kt-menu-item" style="padding-left: 30px;">
                        {% elif group.level == 2 %}
                            <div class="kt-menu-item" style="padding-left: 60px;">
                        {% else %}
                            <div class="kt-menu-item" style="padding-left: 90px;">
                        {% endif %}
                            <a class="kt-menu-link border border-transparent items-center grow kt-menu-item-active:bg-accent/60 dark:menu-item-active:border-border kt-menu-item-active:rounded-lg hover:bg-accent/60 hover:rounded-lg gap-[10px] ps-[10px] pe-[10px] py-[8px]"
                               href="{% url 'nomenclatures:product_groups_edit' group.pk %}" tabindex="0">
                                {% if group.level == 0 %}
                                    <span class="kt-menu-icon items-start text-muted-foreground w-[20px]">
                                        <i class="ki-filled ki-folder text-lg"></i>
                                    </span>
                                {% elif group.level == 1 %}
                                    <span class="kt-menu-icon items-start text-muted-foreground w-[20px]">
                                        <i class="ki-filled ki-abstract-26 text-base"></i>
                                    </span>
                                {% elif group.level == 2 %}
                                    <span class="kt-menu-icon items-start text-muted-foreground w-[20px]">
                                        <i class="ki-filled ki-file text-sm"></i>
                                    </span>
                                {% else %}
                                    <span class="kt-menu-bullet flex w-[6px] relative before:absolute before:top-0 before:size-[6px] before:rounded-full before:bg-muted-foreground"></span>
                                {% endif %}
                                <span class="kt-menu-title text-sm font-normal text-foreground kt-menu-item-active:text-primary kt-menu-item-active:font-semibold kt-menu-link-hover:!text-primary">
                                    <span class="font-bold text-primary">{{ group.code }}</span> - {{ group.name }}
                                </span>

                                <!-- Additional Info Badges -->
                                <div class="flex items-center gap-1.5 ms-auto">
                                    <!-- Active/Inactive Status -->
                                    {% if group.is_active %}
                                        <span class="kt-badge kt-badge-success kt-badge-xs">{% trans "Active" %}</span>
                                    {% else %}
                                        <span class="kt-badge kt-badge-warning kt-badge-xs">{% trans "Inactive" %}</span>
                                    {% endif %}

                                    <!-- Children Count -->
                                    <span class="kt-badge kt-badge-outline kt-badge-xs" title="{% trans 'Subgroups' %}">
                                        <i class="ki-filled ki-abstract-26 text-[10px]"></i> {{ group.children.count|default:"0" }}
                                    </span>

                                    <!-- Products Count -->
                                    <span class="kt-badge kt-badge-light kt-badge-xs" title="{% trans 'Products' %}">
                                        <i class="ki-filled ki-basket-ok text-[10px]"></i> {{ group.product_set.count|default:"0" }}
                                    </span>

                                    <!-- Level Indicator -->
                                    <span class="kt-badge kt-badge-light kt-badge-xs" title="{% trans 'Level' %}">
                                        L{{ group.level }}
                                    </span>




                                </div>
                            </a>
                        </div>
                    {% endfor %}
                </div>
            {% else %}
                <!-- Table View -->
                <div class="table-responsive">
                    <table class="kt-table kt-table-border kt-table-rounded">
                        <thead>
                            <tr>
                                <th>{% trans "Code" %}</th>
                                <th>{% trans "Name" %}</th>
                                <th>{% trans "Parent Group" %}</th>
                                <th>{% trans "Level" %}</th>
                                <th>{% trans "Status" %}</th>
                                <th style="width: 80px; text-align: right;">{% trans "Actions" %}</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for group in object_list %}
                            <tr>
                                <td><strong>{{ group.code }}</strong></td>
                                <td>{{ group.name }}</td>
                                <td>
                                    {% if group.parent %}
                                        {{ group.parent.name }}
                                    {% else %}
                                        <span class="text-muted-foreground">{% trans "Root Group" %}</span>
                                    {% endif %}
                                </td>
                                <td>{{ group.level }}</td>
                                <td>
                                    {% if group.is_active %}
                                        <span class="kt-badge kt-badge-success kt-badge-sm">{% trans "Active" %}</span>
                                    {% else %}
                                        <span class="kt-badge kt-badge-warning kt-badge-sm">{% trans "Inactive" %}</span>
                                    {% endif %}
                                </td>
                                <td style="width: 80px; text-align: right; padding: 8px;">
                                    <div style="display: flex; justify-content: flex-end; gap: 4px;">
                                        <button type="button"
                                                style="width: 28px; height: 28px; display: flex; align-items: center; justify-content: center; border: none; background: transparent; border-radius: 4px; cursor: pointer;"
                                                onclick="showGroupDetailModal({{ group.pk }})"
                                                title="{% trans 'View Details' %}">
                                            <i class="ki-filled ki-eye" style="font-size: 14px; color: #6b7280;"></i>
                                        </button>
                                        <a href="{% url 'nomenclatures:product_groups_edit' group.pk %}"
                                           style="width: 28px; height: 28px; display: flex; align-items: center; justify-content: center; border: none; background: transparent; border-radius: 4px; text-decoration: none;"
                                           title="{% trans 'Edit Group' %}">
                                            <i class="ki-filled ki-notepad-edit" style="font-size: 14px; color: #6b7280;"></i>
                                        </a>
                                        <button type="button"
                                                style="width: 28px; height: 28px; display: flex; align-items: center; justify-content: center; border: none; background: transparent; border-radius: 4px; cursor: pointer;"
                                                onclick="confirmDelete('{% url 'nomenclatures:product_groups_delete' group.pk %}')"
                                                title="{% trans 'Delete Group' %}">
                                            <i class="ki-filled ki-trash" style="font-size: 14px; color: #dc3545;"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="6" class="text-center py-8">
                                    <div class="flex flex-col items-center">
                                        <i class="ki-filled ki-abstract-14 text-muted-foreground text-4xl mb-3"></i>
                                        <h4 class="text-muted-foreground mb-2">{% trans "No Product Groups Found" %}</h4>
                                        <p class="text-muted-foreground">{% trans "Get started by creating your first product group." %}</p>
                                        <a href="{% url 'nomenclatures:product_groups_create' %}" class="kt-btn kt-btn-primary mt-3">
                                            <i class="ki-filled ki-plus"></i>
                                            {% trans "Create First Group" %}
                                        </a>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Modal HTML -->
<div class="kt-modal" data-kt-modal="true" id="groupDetailModal">
    <div class="kt-modal-content" style="max-width: 600px; width: 100%; top: 15%;">
        <!-- Modal Header -->
        <div class="kt-modal-header">
            <h3 class="kt-modal-title" id="groupDetailModalTitle">
                {% trans "Group Details" %}
            </h3>
            <button class="btn btn-sm btn-icon btn-light"
                    data-kt-modal-dismiss="true"
                    title="{% trans 'Close' %}">
                <i class="ki-filled ki-cross"></i>
            </button>
        </div>

        <!-- Modal Body -->
        <div class="kt-modal-body" style="padding-right: 8px;" id="groupDetailModalBody">
            <!-- Loading State -->
            <div id="loadingState" style="border-radius: 8px; background-color: #f1f5f9; width: 100%; flex-grow: 1; height: 380px; display: flex; flex-direction: column; align-items: center; justify-content: center;">
                <div class="spinner-border text-primary mb-3"></div>
                <div class="text-sm text-gray-600">{% trans "Loading..." %}</div>
            </div>

            <!-- Content State - hidden initially -->
            <div id="contentState" style="display: none; padding: 20px; height: 380px; overflow-y: auto;">
                <!-- Header Row -->
                <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 16px; padding: 12px; background-color: #f8fafc; border-radius: 8px;">
                    <div style="width: 40px; height: 40px; background-color: rgba(59, 130, 246, 0.1); border-radius: 8px; display: flex; align-items: center; justify-content: center;">
                        <i class="ki-filled ki-abstract-14" style="color: #3b82f6; font-size: 18px;"></i>
                    </div>
                    <div style="flex: 1; min-width: 0;">
                        <div id="groupName" style="font-weight: 600; color: #1f2937; font-size: 16px; line-height: 1.2;">{% trans "Group Name" %}</div>
                        <div style="display: flex; align-items: center; gap: 8px; margin-top: 4px;">
                            <span id="groupCode" style="font-family: monospace; background-color: #e5e7eb; padding: 2px 6px; border-radius: 4px; font-size: 12px; font-weight: 500;">{% trans "CODE" %}</span>
                            <span style="color: #9ca3af; font-size: 12px;">•</span>
                            <span id="groupLevel" style="font-size: 13px; color: #6b7280;">{% trans "Level" %} 0</span>
                            <span id="groupStatus" style="font-size: 13px;">• {% trans "Active" %}</span>
                        </div>
                    </div>
                </div>

                <!-- Stats Grid -->
                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 12px; margin-bottom: 16px;">
                    <div style="text-align: center; padding: 16px; background-color: #eff6ff; border-radius: 8px;">
                        <div id="statLevel" style="font-size: 24px; font-weight: 700; color: #2563eb; line-height: 1;">0</div>
                        <div style="font-size: 12px; color: #1e40af; margin-top: 4px;">{% trans "Level" %}</div>
                    </div>
                    <div style="text-align: center; padding: 16px; background-color: #f0fdf4; border-radius: 8px;">
                        <div id="statChildren" style="font-size: 24px; font-weight: 700; color: #16a34a; line-height: 1;">0</div>
                        <div style="font-size: 12px; color: #15803d; margin-top: 4px;">{% trans "Children" %}</div>
                    </div>
                    <div style="text-align: center; padding: 16px; background-color: #faf5ff; border-radius: 8px;">
                        <div id="statTotal" style="font-size: 24px; font-weight: 700; color: #9333ea; line-height: 1;">0</div>
                        <div style="font-size: 12px; color: #7c3aed; margin-top: 4px;">{% trans "Total" %}</div>
                    </div>
                </div>

                <!-- Parent Info -->
                <div id="parentInfo" style="display: none; padding: 12px; border: 1px solid #e5e7eb; border-radius: 8px; margin-bottom: 16px;">
                    <div style="font-size: 12px; color: #6b7280; margin-bottom: 6px;">{% trans "Parent Group" %}</div>
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <i class="ki-filled ki-arrow-up" style="color: #9ca3af; font-size: 14px;"></i>
                        <span id="parentName" style="font-weight: 500; font-size: 14px; color: #374151;">{% trans "Parent Name" %}</span>
                    </div>
                </div>

                <!-- Actions -->
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-top: auto;">
                    <a id="editLink" href="#"
                       style="display: flex; align-items: center; justify-content: center; gap: 6px; padding: 10px 16px; background-color: #3b82f6; color: white; text-decoration: none; border-radius: 6px; font-size: 13px; font-weight: 500;">
                        <i class="ki-filled ki-notepad-edit" style="font-size: 14px;"></i>
                        {% trans "Edit" %}
                    </a>
                    <a id="addChildLink" href="#"
                       style="display: flex; align-items: center; justify-content: center; gap: 6px; padding: 10px 16px; background-color: #f3f4f6; color: #374151; text-decoration: none; border-radius: 6px; font-size: 13px; font-weight: 500; border: 1px solid #d1d5db;">
                        <i class="ki-filled ki-plus" style="font-size: 14px;"></i>
                        {% trans "Add New Group" %}
                    </a>
                </div>
            </div>
        </div>

        <!-- Modal Footer -->
        <div class="kt-modal-footer">
            <button type="button" class="btn btn-light" data-kt-modal-dismiss="true">
                {% trans "Close" %}
            </button>
        </div>
    </div>
</div>

<!-- JavaScript for Tree Interactions and View Mode Persistence -->
<script>
// View Mode Persistence
document.addEventListener('DOMContentLoaded', function() {
    // Get saved view mode from localStorage
    const savedViewMode = localStorage.getItem('product_groups_view_mode');
    const currentViewMode = '{{ view_mode }}';

    // If saved mode differs from current, redirect to saved mode
    if (savedViewMode && savedViewMode !== currentViewMode) {
        window.location.href = '{% url "nomenclatures:product_groups" %}?view=' + savedViewMode;
    }

    // Save view mode when buttons are clicked
    document.querySelectorAll('.kt-btn-group a').forEach(function(btn) {
        btn.addEventListener('click', function(e) {
            const urlParams = new URLSearchParams(this.href.split('?')[1]);
            const viewMode = urlParams.get('view') || 'flat';
            localStorage.setItem('product_groups_view_mode', viewMode);

            // Also set a cookie for server-side persistence
            document.cookie = `product_groups_view=${viewMode};path=/;max-age=31536000`;
        });
    });
});

// Modal JavaScript
window.showGroupDetailModal = async function(groupId) {
    const modalEl = document.getElementById('groupDetailModal');
    const modal = KTModal.getInstance(modalEl);
    const modalTitle = document.getElementById('groupDetailModalTitle');

    if (modal) {
        modal.show();
    }

    // Reset modal state
    document.getElementById('loadingState').style.display = 'flex';
    document.getElementById('contentState').style.display = 'none';

    try {
        const response = await fetch(`{% url 'nomenclatures:product_groups_detail_modal' 0 %}`.replace('0', groupId));
        const data = await response.json();

        if (data.success) {
            modalTitle.textContent = data.title;

            // Show content, hide loading
            document.getElementById('loadingState').style.display = 'none';
            document.getElementById('contentState').style.display = 'block';

            // Populate data
            document.getElementById('groupName').textContent = data.group?.name || '{% trans "N/A" %}';
            document.getElementById('groupCode').textContent = data.group?.code || '{% trans "N/A" %}';
            document.getElementById('groupLevel').textContent = `{% trans "Level" %} ${data.group?.level || 0}`;
            document.getElementById('groupStatus').textContent = data.group?.is_active ? '• {% trans "Active" %}' : '• {% trans "Inactive" %}';
            document.getElementById('groupStatus').style.color = data.group?.is_active ? '#059669' : '#d97706';

            // Stats
            document.getElementById('statLevel').textContent = data.group?.level || 0;
            document.getElementById('statChildren').textContent = data.children_count || 0;
            document.getElementById('statTotal').textContent = data.descendants_count || 0;

            // Parent info
            if (data.group?.parent) {
                document.getElementById('parentInfo').style.display = 'block';
                document.getElementById('parentName').textContent = data.group.parent.name;
            } else {
                document.getElementById('parentInfo').style.display = 'none';
            }

            // Links
            document.getElementById('editLink').href = `/nomenclatures/product-groups/${data.group?.id}/edit/`;
            document.getElementById('addChildLink').href = `/nomenclatures/product-groups/create/?parent=${data.group?.id}`;

        } else {
            throw new Error(data.error || '{% trans "Failed to load group details" %}');
        }
    } catch (error) {
        console.error('{% trans "Error:" %}', error);
        document.getElementById('loadingState').innerHTML = '<div class="text-danger text-center py-4">Error loading data</div>';
    }
};

window.confirmDelete = function(deleteUrl) {
    if (confirm('{% trans "Delete this group?" %}')) {
        window.location.href = deleteUrl;
    }
};
</script>
{% endblock %}